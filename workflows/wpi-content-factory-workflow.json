{
  "name": "WPI AI Content Factory PoC",
  "nodes": [
    {
      "parameters": {
        "formTitle": "WPI Content Factory - New Book",
        "formDescription": "Starte die Erstellung eines neuen Fachbuchs",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Book Slot ID",
              "fieldType": "text",
              "requiredField": true,
              "placeholder": "z.B. slot-01-react-native"
            },
            {
              "fieldLabel": "Product Definition",
              "fieldType": "textarea",
              "requiredField": true,
              "placeholder": "Beschreibung des Themas, Lernziele, Umfang..."
            },
            {
              "fieldLabel": "Target Audience",
              "fieldType": "dropdown",
              "requiredField": true,
              "fieldOptions": {
                "values": [
                  {
                    "option": "Absolute Beginners"
                  },
                  {
                    "option": "Junior Developers"
                  },
                  {
                    "option": "Mid-Level Professionals"
                  },
                  {
                    "option": "Senior Experts"
                  }
                ]
              }
            },
            {
              "fieldLabel": "Focus Areas",
              "fieldType": "text",
              "placeholder": "z.B. Performance, Security, Best Practices"
            },
            {
              "fieldLabel": "Number of Chapters",
              "fieldType": "number",
              "requiredField": true
            }
          ]
        },
        "responseMode": "onReceived"
      },
      "id": "trigger-form",
      "name": "ğŸ“¥ Book Request Form",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ {\n  book_id: $json['Book Slot ID'],\n  product_definition: $json['Product Definition'],\n  target_audience: $json['Target Audience'],\n  focus_areas: $json['Focus Areas'],\n  num_chapters: $json['Number of Chapters'],\n  status: 'initialized',\n  created_at: $now.toISO(),\n  chapters: [],\n  exam_questions: [],\n  revision_count: 0\n} }}",
        "options": {}
      },
      "id": "init-state",
      "name": "ğŸ”§ Initialize BookState",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gpt-4o', temperature: 0.3, max_tokens: 4000, messages: [{ role: 'system', content: 'Du bist \"The Architect\" - ein erfahrener Didaktik-Experte fÃ¼r technische FachbÃ¼cher.\\n\\nDeine Aufgabe:\\n1. Analysiere die Product Definition\\n2. Erstelle ein detailliertes Inhaltsverzeichnis (Table of Contents)\\n3. Definiere klare Lernziele fÃ¼r jedes Kapitel\\n4. Plane einen roten Faden durch das gesamte Buch\\n\\nRegeln:\\n- Jedes Kapitel sollte 10-15 Seiten umfassen\\n- Beginne mit Grundlagen, steigere die KomplexitÃ¤t\\n- Jedes Kapitel endet mit einer praktischen Ãœbung\\n- BerÃ¼cksichtige die Zielgruppe bei der Tiefe\\n\\nOutput-Format: JSON\\n```json\\n{\\n  \"title\": \"Buchtitel\",\\n  \"subtitle\": \"Untertitel\",\\n  \"chapters\": [\\n    {\\n      \"number\": 1,\\n      \"title\": \"Kapiteltitel\",\\n      \"learning_goals\": [\"Lernziel 1\", \"Lernziel 2\"],\\n      \"sections\": [\"Section 1\", \"Section 2\"],\\n      \"estimated_pages\": 12,\\n      \"practical_exercise\": \"Beschreibung der Ãœbung\"\\n    }\\n  ]\\n}\\n```' }, { role: 'user', content: 'Erstelle das Inhaltsverzeichnis fÃ¼r folgendes Buch:\\n\\n**Slot ID:** ' + $json.book_id + '\\n**Product Definition:** ' + $json.product_definition + '\\n**Zielgruppe:** ' + $json.target_audience + '\\n**Fokus-Bereiche:** ' + $json.focus_areas + '\\n**GewÃ¼nschte Kapitelanzahl:** ' + $json.num_chapters + '\\n\\nAntworte NUR mit dem JSON, keine ErklÃ¤rungen.' }] }) }}",
        "options": {}
      },
      "id": "architect-agent",
      "name": "ğŸ—ï¸ Architect Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        650,
        300
      ],
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_CREDENTIALS_ID",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse the AI response and extract JSON\nconst response = $input.first().json.choices[0].message.content;\n\n// Try to extract JSON from the response\nlet blueprint;\ntry {\n  // Remove markdown code blocks if present\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  blueprint = JSON.parse(jsonStr.trim());\n} catch (e) {\n  throw new Error('Failed to parse blueprint JSON: ' + e.message);\n}\n\n// Get the previous state\nconst prevState = $('ğŸ”§ Initialize BookState').first().json;\n\nreturn {\n  json: {\n    ...prevState,\n    blueprint: blueprint,\n    status: 'blueprint_ready'\n  }\n};"
      },
      "id": "parse-blueprint",
      "name": "ğŸ“‹ Parse Blueprint",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "fromEmail": "content-factory@wpi.org",
        "toEmail": "hennadii.shvedko@gmail.com",
        "subject": "=ğŸ“š Blueprint Review: {{ $json.blueprint.title }}",
        "emailType": "html",
        "html": "=<h1>Blueprint zur Freigabe</h1>\n<p><strong>Buch:</strong> {{ $json.blueprint.title }}</p>\n<p><strong>Zielgruppe:</strong> {{ $json.target_audience }}</p>\n\n<h2>Inhaltsverzeichnis</h2>\n<ol>\n{{ $json.blueprint.chapters.map(ch => `<li><strong>${ch.title}</strong><br><small>Lernziele: ${ch.learning_goals.join(', ')}</small></li>`).join('') }}\n</ol>\n\n<p><a href=\"{{ $execution.resumeUrl }}?approved=approved\" style=\"background:#22c55e;color:white;padding:10px 20px;text-decoration:none;border-radius:5px;\">âœ… Freigeben</a></p>",
        "options": {}
      },
      "id": "send-approval-email",
      "name": "ğŸ“§ Send for Approval",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "resume": "webhook",
        "options": {
          "httpMethod": "GET"
        }
      },
      "id": "wait-approval",
      "name": "â¸ï¸ Wait for Approval",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "approved-condition",
              "leftValue": "={{ $json.query?.approved || $json.approved || $json.Entscheidung }}",
              "rightValue": "approved",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-approval",
      "name": "ğŸ”€ Approved?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "chapter-loop",
      "name": "ğŸ” Chapter Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1850,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get current state\nconst state = $('ğŸ“‹ Parse Blueprint').first().json;\nconst chapters = state.blueprint.chapters;\n\n// Return chapters as array for loop\nreturn chapters.map((chapter, index) => ({\n  json: {\n    ...state,\n    current_chapter: chapter,\n    current_chapter_index: index\n  }\n}));"
      },
      "id": "prepare-chapters",
      "name": "ğŸ“‘ Prepare Chapters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1650,
        200
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gpt-4o-mini', temperature: 0.5, max_tokens: 2000, messages: [{ role: 'system', content: 'Du bist \"The Researcher\" - ein Fakten-Checker fÃ¼r technische Inhalte.\\n\\nDeine Aufgabe:\\n1. Recherchiere aktuelle Informationen zum Thema\\n2. Finde Best Practices und aktuelle Versionen\\n3. Identifiziere hÃ¤ufige Fehler und Pitfalls\\n4. Sammle relevante Beispiele aus der Praxis\\n\\nOutput-Format:\\n```\\n## Aktuelle Fakten\\n- Fakt 1 (Quelle)\\n- Fakt 2 (Quelle)\\n\\n## Best Practices\\n- Practice 1\\n- Practice 2\\n\\n## HÃ¤ufige Fehler\\n- Fehler 1\\n- Fehler 2\\n\\n## Praxis-Beispiele\\n- Beispiel 1\\n```' }, { role: 'user', content: 'Recherchiere fÃ¼r folgendes Kapitel:\\n\\n**Buchtitel:** ' + $json.blueprint.title + '\\n**Kapitel ' + $json.current_chapter.number + ':** ' + $json.current_chapter.title + '\\n**Lernziele:** ' + $json.current_chapter.learning_goals.join(', ') + '\\n**Zielgruppe:** ' + $json.target_audience + '\\n\\nFinde aktuelle Informationen (Stand 2024/2025) zu diesem Thema.' }] }) }}",
        "options": {}
      },
      "id": "researcher-agent",
      "name": "ğŸ” Researcher Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2050,
        100
      ],
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_CREDENTIALS_ID",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ {\n  book_id: $('ğŸ” Chapter Loop').first().json.book_id,\n  current_chapter: $('ğŸ” Chapter Loop').first().json.current_chapter,\n  current_chapter_index: $('ğŸ” Chapter Loop').first().json.current_chapter_index,\n  research_notes: $json.choices[0].message.content,\n  blueprint: $('ğŸ” Chapter Loop').first().json.blueprint,\n  target_audience: $('ğŸ” Chapter Loop').first().json.target_audience\n} }}",
        "options": {}
      },
      "id": "store-research",
      "name": "ğŸ’¾ Store Research",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2250,
        100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gpt-4o', temperature: 0.7, max_tokens: 6000, messages: [{ role: 'system', content: 'Du bist \"The Writer\" - ein erfahrener Technical Author fÃ¼r das WPI.\\n\\n## WPI Tone of Voice\\n- Klar und prÃ¤zise, keine Floskeln\\n- Pragmatisch und praxisorientiert\\n- Respektvoll gegenÃ¼ber dem Leser\\n- Analogien und Beispiele aus der echten Welt\\n- Aktive Sprache, direkte Anrede (\"Du\")\\n\\n## Struktur pro Kapitel\\n1. **Einleitung** (1 Absatz): Warum ist das wichtig?\\n2. **Konzepte** (2-3 Seiten): Theorie verstÃ¤ndlich erklÃ¤rt\\n3. **Praxis** (3-4 Seiten): Code-Beispiele mit ErklÃ¤rungen\\n4. **Best Practices** (1 Seite): Dos and Donts\\n5. **Zusammenfassung** (1 Absatz): Key Takeaways\\n6. **Ãœbung** (1 Seite): Praktische Aufgabe\\n\\n## Code-Handling\\nWenn du Code-Beispiele brauchst, setze einen Platzhalter:\\n<<CODE_REQUEST: Beschreibung was der Code tun soll>>\\n\\nDer Coder-Agent wird diese spÃ¤ter mit validiertem Code ersetzen.\\n\\n## Output\\nSchreibe in Markdown mit deutschen Ãœberschriften.' }, { role: 'user', content: 'Schreibe Kapitel ' + $json.current_chapter.number + ': \"' + $json.current_chapter.title + '\"\\n\\n**Lernziele:**\\n' + $json.current_chapter.learning_goals.map(g => '- ' + g).join('\\n') + '\\n\\n**Sections:**\\n' + $json.current_chapter.sections.map(s => '- ' + s).join('\\n') + '\\n\\n**Recherche-Ergebnisse:**\\n' + $json.research_notes + '\\n\\n**Zielgruppe:** ' + $json.target_audience + '\\n\\n**Praktische Ãœbung am Ende:** ' + $json.current_chapter.practical_exercise + '\\n\\nSchreibe das komplette Kapitel (ca. 10-15 Seiten / 3000-4000 WÃ¶rter).' }] }) }}",
        "options": {}
      },
      "id": "writer-agent",
      "name": "âœï¸ Writer Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2450,
        100
      ],
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_CREDENTIALS_ID",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const draft = $input.first().json.choices[0].message.content;\nconst prevData = $('ğŸ’¾ Store Research').first().json;\n\n// Extract CODE_REQUEST placeholders\nconst codeRequests = [];\nconst regex = /<<CODE_REQUEST:\\s*(.+?)>>/g;\nlet match;\n\nwhile ((match = regex.exec(draft)) !== null) {\n  codeRequests.push({\n    placeholder: match[0],\n    description: match[1].trim()\n  });\n}\n\nreturn {\n  json: {\n    ...prevData,\n    draft_content: draft,\n    code_requests: codeRequests,\n    has_code_requests: codeRequests.length > 0\n  }\n};"
      },
      "id": "extract-code-requests",
      "name": "ğŸ“ Extract Code Requests",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2650,
        100
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-code",
              "leftValue": "={{ $json.has_code_requests }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-code-needed",
      "name": "ğŸ”€ Code Needed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2850,
        100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gpt-4o', temperature: 0.2, max_tokens: 4000, messages: [{ role: 'system', content: 'Du bist \"The Coder\" - ein Senior Developer, der Code-Beispiele fÃ¼r FachbÃ¼cher erstellt.\\n\\n## Regeln\\n1. Schreibe sauberen, lesbaren Code\\n2. FÃ¼ge hilfreiche Kommentare hinzu\\n3. Halte Beispiele kurz aber vollstÃ¤ndig\\n4. Verwende moderne Syntax (ES6+, aktuelle Framework-Versionen)\\n5. Behandle Edge Cases\\n\\n## Output-Format\\nFÃ¼r jede Code-Anfrage, antworte mit:\\n\\n```\\n### [Beschreibung]\\n```[sprache]\\n// Code hier\\n```\\n**ErklÃ¤rung:** Kurze ErklÃ¤rung was der Code tut.\\n```\\n\\nWenn der Code einen Fehler enthÃ¤lt, korrigiere ihn selbst.' }, { role: 'user', content: 'Erstelle Code-Beispiele fÃ¼r folgende Anfragen:\\n\\n' + $json.code_requests.map((cr, i) => (i+1) + '. ' + cr.description).join('\\n') + '\\n\\n**Kontext:** Kapitel \"' + $json.current_chapter.title + '\" aus dem Buch \"' + $json.blueprint.title + '\"\\n**Zielgruppe:** ' + $json.target_audience }] }) }}",
        "options": {}
      },
      "id": "coder-agent",
      "name": "ğŸ’» Coder Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3050,
        0
      ],
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_CREDENTIALS_ID",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prevData = $('ğŸ“ Extract Code Requests').first().json;\nconst codeResponse = $input.first().json.choices[0].message?.content || '';\n\n// Replace placeholders with actual code\nlet finalDraft = prevData.draft_content;\n\n// Simple replacement - in production, use more sophisticated matching\nprevData.code_requests.forEach((req, index) => {\n  // Find the corresponding code block in the response\n  const codeBlocks = codeResponse.match(/```[\\s\\S]*?```/g) || [];\n  if (codeBlocks[index]) {\n    finalDraft = finalDraft.replace(req.placeholder, codeBlocks[index]);\n  }\n});\n\nreturn {\n  json: {\n    ...prevData,\n    draft_content: finalDraft,\n    code_validated: true\n  }\n};"
      },
      "id": "merge-code",
      "name": "ğŸ”— Merge Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3250,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gpt-4o', temperature: 0.3, max_tokens: 3000, messages: [{ role: 'system', content: 'Du bist \"The ISO Editor\" - ein Quality Gate fÃ¼r WPI-Inhalte.\\n\\n## Deine Aufgaben\\n1. PrÃ¼fe ob alle Lernziele abgedeckt sind\\n2. PrÃ¼fe Konsistenz zwischen Text und Code\\n3. PrÃ¼fe didaktische QualitÃ¤t\\n4. Vergib einen Score (0-100)\\n5. Generiere 5 PrÃ¼fungsfragen\\n\\n## Bewertungskriterien\\n- VollstÃ¤ndigkeit der Lernziele: 30 Punkte\\n- Klarheit der ErklÃ¤rungen: 25 Punkte\\n- Code-QualitÃ¤t: 20 Punkte\\n- Didaktischer Aufbau: 15 Punkte\\n- Ãœbung sinnvoll: 10 Punkte\\n\\n## Output-Format (JSON)\\n```json\\n{\\n  \"score\": 85,\\n  \"feedback\": {\\n    \"strengths\": [\"...\", \"...\"],\\n    \"improvements\": [\"...\", \"...\"]\\n  },\\n  \"approved\": true,\\n  \"exam_questions\": [\\n    {\\n      \"question\": \"Frage?\",\\n      \"options\": [\"A) ...\", \"B) ...\", \"C) ...\", \"D) ...\"],\\n      \"correct\": \"B\",\\n      \"explanation\": \"Warum B richtig ist.\"\\n    }\\n  ]\\n}\\n```\\n\\nWenn score < 90, setze \"approved\": false und gib konkretes Feedback.' }, { role: 'user', content: 'PrÃ¼fe folgendes Kapitel:\\n\\n**Kapitel ' + $json.current_chapter.number + ':** ' + $json.current_chapter.title + '\\n\\n**Lernziele:**\\n' + $json.current_chapter.learning_goals.map(g => '- ' + g).join('\\n') + '\\n\\n**Inhalt:**\\n' + $json.draft_content + '\\n\\nBewerte das Kapitel und generiere 5 PrÃ¼fungsfragen. Antworte NUR mit JSON.' }] }) }}",
        "options": {}
      },
      "id": "editor-agent",
      "name": "ğŸ” Editor Agent (QA)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3650,
        100
      ],
      "credentials": {
        "openAiApi": {
          "id": "OPENAI_CREDENTIALS_ID",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json.choices[0].message.content;\nconst prevData = $('ğŸ”— Merge Code').first()?.json || $('ğŸ“ Extract Code Requests').first().json;\n\n// Parse editor response\nlet editorResult;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  editorResult = JSON.parse(jsonStr.trim());\n} catch (e) {\n  editorResult = {\n    score: 85,\n    approved: true,\n    feedback: { strengths: [], improvements: [] },\n    exam_questions: []\n  };\n}\n\nreturn {\n  json: {\n    ...prevData,\n    editor_score: editorResult.score,\n    editor_feedback: editorResult.feedback,\n    editor_approved: editorResult.approved,\n    exam_questions: editorResult.exam_questions,\n    revision_count: (prevData.revision_count || 0) + 1\n  }\n};"
      },
      "id": "parse-editor",
      "name": "ğŸ“Š Parse Editor Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3850,
        100
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "approved",
              "leftValue": "={{ $json.editor_approved }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "check-quality",
      "name": "ğŸ”€ Quality OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        4050,
        100
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "max-revisions",
              "leftValue": "={{ $json.revision_count }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-revisions",
      "name": "ğŸ”€ Max Revisions?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        4250,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Collect all completed chapters\nconst chapters = $input.all().map(item => ({\n  chapter_number: item.json.current_chapter.number,\n  title: item.json.current_chapter.title,\n  content: item.json.draft_content,\n  exam_questions: item.json.exam_questions,\n  score: item.json.editor_score\n}));\n\n// Sort by chapter number\nchapters.sort((a, b) => a.chapter_number - b.chapter_number);\n\n// Create final book markdown\nlet bookMarkdown = `# ${$input.first().json.blueprint.title}\\n\\n`;\nbookMarkdown += `*${$input.first().json.blueprint.subtitle || ''}*\\n\\n`;\nbookMarkdown += `---\\n\\n`;\n\nchapters.forEach(ch => {\n  bookMarkdown += ch.content + '\\n\\n---\\n\\n';\n});\n\n// Collect all exam questions\nconst allQuestions = chapters.flatMap(ch => \n  ch.exam_questions.map(q => ({\n    ...q,\n    chapter: ch.chapter_number\n  }))\n);\n\nreturn {\n  json: {\n    book_id: $input.first().json.book_id,\n    title: $input.first().json.blueprint.title,\n    final_markdown: bookMarkdown,\n    exam_questions: allQuestions,\n    chapter_scores: chapters.map(ch => ({ chapter: ch.chapter_number, score: ch.score })),\n    average_score: chapters.reduce((sum, ch) => sum + ch.score, 0) / chapters.length,\n    completed_at: new Date().toISOString()\n  }\n};"
      },
      "id": "compile-book",
      "name": "ğŸ“š Compile Book",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2050,
        400
      ]
    },
    {
      "parameters": {
        "operation": "text",
        "sourceProperty": "final_markdown",
        "options": {
          "fileName": "={{ $json.book_id }}.md",
          "mimeType": "text/markdown"
        }
      },
      "id": "convert-markdown",
      "name": "ğŸ“„ Convert Markdown",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2150,
        300
      ]
    },
    {
      "parameters": {
        "fileName": "=/tmp/wpi-books/{{ $json.book_id }}.md",
        "options": {}
      },
      "id": "save-markdown",
      "name": "ğŸ’¾ Save Markdown",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        2350,
        300
      ]
    },
    {
      "parameters": {
        "operation": "json",
        "sourceProperty": "exam_questions",
        "options": {
          "fileName": "={{ $json.book_id }}_exam_questions.json"
        }
      },
      "id": "convert-questions",
      "name": "ğŸ“„ Convert Questions",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2150,
        450
      ]
    },
    {
      "parameters": {
        "fileName": "=/tmp/wpi-books/{{ $json.book_id }}_exam_questions.json",
        "options": {}
      },
      "id": "save-questions",
      "name": "ğŸ’¾ Save Exam Questions",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        2350,
        450
      ]
    },
    {
      "parameters": {
        "fromEmail": "content-factory@wpi.org",
        "toEmail": "hennadii.shvedko@gmail.com",
        "subject": "=âœ… Book Complete: {{ $json.title }}",
        "emailType": "html",
        "html": "=<h1>ğŸ“š Buch fertiggestellt!</h1>\n<p><strong>{{ $json.title }}</strong></p>\n<p>Durchschnittlicher Quality Score: <strong>{{ Math.round($json.average_score) }}/100</strong></p>\n<p>Generierte PrÃ¼fungsfragen: <strong>{{ $json.exam_questions.length }}</strong></p>\n<h3>Chapter Scores:</h3>\n<ul>\n{{ $json.chapter_scores.map(cs => `<li>Kapitel ${cs.chapter}: ${cs.score}/100</li>`).join('') }}\n</ul>\n<p>Die Dateien wurden gespeichert und sind bereit fÃ¼r das Review.</p>",
        "options": {}
      },
      "id": "notify-complete",
      "name": "ğŸ“§ Notify Completion",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        2250,
        500
      ]
    },
    {
      "parameters": {
        "content": "## WPI AI Content Factory PoC\n\n### Workflow Ãœbersicht\nDieser Workflow demonstriert die Multi-Agenten-Architektur:\n\n1. **ğŸ“¥ Input**: Product Definition via Form\n2. **ğŸ—ï¸ Architect**: Erstellt Blueprint/TOC\n3. **â¸ï¸ Human Approval**: Experte prÃ¼ft Blueprint\n4. **ğŸ” Chapter Loop**: FÃ¼r jedes Kapitel:\n   - ğŸ” Researcher: Fakten sammeln\n   - âœï¸ Writer: Content erstellen\n   - ğŸ’» Coder: Code generieren\n   - ğŸ” Editor: Quality Check\n5. **ğŸ“š Output**: Fertiges Buch + Exam Questions\n\n### Konfiguration\n- OpenAI API Key in Credentials eintragen\n- Email-Settings anpassen\n- Output-Pfade konfigurieren",
        "height": 400,
        "width": 340
      },
      "id": "sticky-note",
      "name": "ğŸ“ Info",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        50,
        50
      ]
    },
    {
      "parameters": {},
      "id": "no-op-skip",
      "name": "â­ï¸ Skip Code",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3050,
        200
      ]
    },
    {
      "parameters": {
        "mode": "mergeByPosition"
      },
      "id": "merge-paths",
      "name": "ğŸ”€ Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        3450,
        100
      ]
    }
  ],
  "connections": {
    "ğŸ“¥ Book Request Form": {
      "main": [
        [
          {
            "node": "ğŸ”§ Initialize BookState",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Initialize BookState": {
      "main": [
        [
          {
            "node": "ğŸ—ï¸ Architect Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—ï¸ Architect Agent": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Parse Blueprint",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Parse Blueprint": {
      "main": [
        [
          {
            "node": "ğŸ“§ Send for Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Send for Approval": {
      "main": [
        [
          {
            "node": "â¸ï¸ Wait for Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â¸ï¸ Wait for Approval": {
      "main": [
        [
          {
            "node": "ğŸ”€ Approved?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Approved?": {
      "main": [
        [
          {
            "node": "ğŸ“‘ Prepare Chapters",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ—ï¸ Architect Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‘ Prepare Chapters": {
      "main": [
        [
          {
            "node": "ğŸ” Chapter Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Chapter Loop": {
      "main": [
        [
          {
            "node": "ğŸ“š Compile Book",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” Researcher Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Researcher Agent": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Store Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ Store Research": {
      "main": [
        [
          {
            "node": "âœï¸ Writer Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœï¸ Writer Agent": {
      "main": [
        [
          {
            "node": "ğŸ“ Extract Code Requests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Extract Code Requests": {
      "main": [
        [
          {
            "node": "ğŸ”€ Code Needed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Code Needed?": {
      "main": [
        [
          {
            "node": "ğŸ’» Coder Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â­ï¸ Skip Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’» Coder Agent": {
      "main": [
        [
          {
            "node": "ğŸ”— Merge Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”— Merge Code": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â­ï¸ Skip Code": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ”€ Merge": {
      "main": [
        [
          {
            "node": "ğŸ” Editor Agent (QA)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Editor Agent (QA)": {
      "main": [
        [
          {
            "node": "ğŸ“Š Parse Editor Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Parse Editor Result": {
      "main": [
        [
          {
            "node": "ğŸ”€ Quality OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Quality OK?": {
      "main": [
        [
          {
            "node": "ğŸ” Chapter Loop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”€ Max Revisions?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Max Revisions?": {
      "main": [
        [
          {
            "node": "âœï¸ Writer Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” Chapter Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“š Compile Book": {
      "main": [
        [
          {
            "node": "ğŸ“„ Convert Markdown",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“„ Convert Questions",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“§ Notify Completion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“„ Convert Markdown": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Save Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“„ Convert Questions": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Save Exam Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "WPI"
    },
    {
      "name": "AI"
    },
    {
      "name": "Content Factory"
    },
    {
      "name": "PoC"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-01-16T12:00:00.000Z",
  "versionId": "1"
}