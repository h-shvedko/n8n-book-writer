{
  "name": "WPI AI Content Factory PoC",
  "nodes": [
    {
      "parameters": {
        "path": "b7a884e4-ab27-4399-b0c5-bea920063424",
        "formTitle": "WPI Content Factory - New Book",
        "formDescription": "Starte die Erstellung eines neuen Fachbuchs",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Book Slot ID",
              "placeholder": "z.B. slot-01-react-native",
              "requiredField": true
            },
            {
              "fieldLabel": "Product Definition",
              "fieldType": "textarea",
              "placeholder": "Beschreibung des Themas, Lernziele, Umfang...",
              "requiredField": true
            },
            {
              "fieldLabel": "Target Audience",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "Absolute Beginners"
                  },
                  {
                    "option": "Junior Developers"
                  },
                  {
                    "option": "Mid-Level Professionals"
                  },
                  {
                    "option": "Senior Experts"
                  }
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "Focus Areas",
              "placeholder": "z.B. Performance, Security, Best Practices"
            },
            {
              "fieldLabel": "Number of Chapters",
              "fieldType": "number",
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "id": "84a84996-b3d5-493e-b369-af277239d567",
      "name": "ğŸ“¥ Book Request Form",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.1,
      "position": [
        -25328,
        8672
      ],
      "webhookId": "b7a884e4-ab27-4399-b0c5-bea920063424"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ {\n  book_id: $json['Book Slot ID'],\n  product_definition: $json['Product Definition'],\n  target_audience: $json['Target Audience'],\n  focus_areas: $json['Focus Areas'],\n  num_chapters: $json['Number of Chapters'],\n  status: 'initialized',\n  created_at: $now.toISO(),\n  chapters: [],\n  exam_questions: [],\n  revision_count: 0\n} }}",
        "options": {}
      },
      "id": "6c325252-a272-4d4a-81b2-579c1f8108f4",
      "name": "ğŸ”§ Initialize BookState",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -25104,
        8672
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"temperature\": 0.3,\n  \"max_tokens\": 4000,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Du bist \\\"The Architect\\\" - ein erfahrener Didaktik-Experte fÃ¼r technische FachbÃ¼cher.\\n\\nDeine Aufgabe:\\n1. Analysiere die Product Definition\\n2. Erstelle ein detailliertes Inhaltsverzeichnis (Table of Contents)\\n3. Definiere klare Lernziele fÃ¼r jedes Kapitel\\n4. Plane einen roten Faden durch das gesamte Buch\\n\\nRegeln:\\n- Jedes Kapitel sollte 10-15 Seiten umfassen\\n- Beginne mit Grundlagen, steigere die KomplexitÃ¤t\\n- Jedes Kapitel endet mit einer praktischen Ãœbung\\n- BerÃ¼cksichtige die Zielgruppe bei der Tiefe\\n\\nOutput-Format: JSON\\n```json\\n{\\n  \\\"title\\\": \\\"Buchtitel\\\",\\n  \\\"subtitle\\\": \\\"Untertitel\\\",\\n  \\\"chapters\\\": [\\n    {\\n      \\\"number\\\": 1,\\n      \\\"title\\\": \\\"Kapiteltitel\\\",\\n      \\\"learning_goals\\\": [\\\"Lernziel 1\\\", \\\"Lernziel 2\\\"],\\n      \\\"sections\\\": [\\\"Section 1\\\", \\\"Section 2\\\"],\\n      \\\"estimated_pages\\\": 12,\\n      \\\"practical_exercise\\\": \\\"Beschreibung der Ãœbung\\\"\\n    }\\n  ]\\n}\\n```\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Erstelle das Inhaltsverzeichnis fÃ¼r folgendes Buch:\\n\\n**Slot ID:** {{ $json.book_id }}\\n**Product Definition:** {{ $json.product_definition }}\\n**Zielgruppe:** {{ $json.target_audience }}\\n**Fokus-Bereiche:** {{ $json.focus_areas }}\\n**GewÃ¼nschte Kapitelanzahl:** {{ $json.num_chapters }}\\n\\nAntworte NUR mit dem JSON, keine ErklÃ¤rungen.\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "66a11e3a-bd72-4f91-989c-a1d86677a80c",
      "name": "ğŸ—ï¸ Architect Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -24880,
        8672
      ],
      "credentials": {
        "openAiApi": {
          "id": "Oh3Rnj32fETJUF9U",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse the AI response and extract JSON\nconst response = $input.first().json.choices[0].message.content;\n\n// Try to extract JSON from the response\nlet blueprint;\ntry {\n  // Remove markdown code blocks if present\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  blueprint = JSON.parse(jsonStr.trim());\n} catch (e) {\n  throw new Error('Failed to parse blueprint JSON: ' + e.message);\n}\n\n// Get the previous state\nconst prevState = $('ğŸ”§ Initialize BookState').first().json;\n\nreturn {\n  json: {\n    ...prevState,\n    blueprint: blueprint,\n    status: 'blueprint_ready'\n  }\n};"
      },
      "id": "6a83a70f-e696-4681-8ba9-bec1264f11f2",
      "name": "ğŸ“‹ Parse Blueprint",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -24656,
        8600
      ]
    },
    {
      "parameters": {
        "fromEmail": "content-factory@wpi.org",
        "toEmail": "hennadii.shvedko@gmail.com",
        "subject": "=ğŸ“š Blueprint Review: {{ $json.blueprint.title }}",
        "html": "=<h1>Blueprint zur Freigabe</h1>\n<p><strong>Buch:</strong> {{ $json.blueprint.title }}</p>\n<p><strong>Zielgruppe:</strong> {{ $json.target_audience }}</p>\n\n<h2>Inhaltsverzeichnis</h2>\n<ol>\n{{ $json.blueprint.chapters.map(ch => `<li><strong>${ch.title}</strong><br><small>Lernziele: ${ch.learning_goals.join(', ')}</small></li>`).join('') }}\n</ol>\n\n<p><a href=\"{{ $execution.resumeUrl }}?approved=approved\" style=\"background:#22c55e;color:white;padding:10px 20px;text-decoration:none;border-radius:5px;\">âœ… Freigeben</a></p>",
        "options": {}
      },
      "id": "73287a0d-eaaa-410c-b337-8dcf24d6e9da",
      "name": "ğŸ“§ Send for Approval",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -24432,
        8600
      ],
      "webhookId": "74dc73b1-6d3f-432a-b59f-f214ce13e50c",
      "credentials": {
        "smtp": {
          "id": "OjlJbmPfeYsQ6qw1",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "resume": "webhook",
        "options": {}
      },
      "id": "65946893-acae-4ebd-9bfa-e2779f881f2a",
      "name": "â¸ï¸ Wait for Approval",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -24208,
        8600
      ],
      "webhookId": "c5dc6acf-3a8a-4224-8ca7-d424d2ff07b0"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "approved-condition",
              "leftValue": "={{ $json.query?.approved || $json.approved || $json.Entscheidung }}",
              "rightValue": "approved",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5e22420f-2ef9-4af8-8d95-e8c658ee1c6c",
      "name": "ğŸ”€ Approved?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -23984,
        8672
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "6563e236-c4e1-40df-9066-f952810efaf7",
      "name": "ğŸ” Chapter Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -23536,
        8672
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get current state\nconst state = $('ğŸ“‹ Parse Blueprint').first().json;\nconst chapters = state.blueprint.chapters;\n\n// Return chapters as array for loop\nreturn chapters.map((chapter, index) => ({\n  json: {\n    ...state,\n    current_chapter: chapter,\n    current_chapter_index: index\n  }\n}));"
      },
      "id": "63ca5c00-2b98-4221-8bcc-648ff2633136",
      "name": "ğŸ“‘ Prepare Chapters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -23760,
        8672
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"temperature\": 0.5,\n  \"max_tokens\": 2000,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Du bist \\\"The Researcher\\\" - ein Fakten-Checker fÃ¼r technische Inhalte.\\n\\nDeine Aufgabe:\\n1. Recherchiere aktuelle Informationen zum Thema\\n2. Finde Best Practices und aktuelle Versionen\\n3. Identifiziere hÃ¤ufige Fehler und Pitfalls\\n4. Sammle relevante Beispiele aus der Praxis\\n\\nOutput-Format:\\n```\\n## Aktuelle Fakten\\n- Fakt 1 (Quelle)\\n- Fakt 2 (Quelle)\\n\\n## Best Practices\\n- Practice 1\\n- Practice 2\\n\\n## HÃ¤ufige Fehler\\n- Fehler 1\\n- Fehler 2\\n\\n## Praxis-Beispiele\\n- Beispiel 1\\n```\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Recherchiere fÃ¼r folgendes Kapitel:\\n\\n**Buchtitel:** {{ $json.blueprint.title }}\\n**Kapitel {{ $json.current_chapter.number }}:** {{ $json.current_chapter.title }}\\n**Lernziele:** {{ $json.current_chapter.learning_goals.join(', ') }}\\n**Zielgruppe:** {{ $json.target_audience }}\\n\\nFinde aktuelle Informationen (Stand 2024/2025) zu diesem Thema.\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "d8e0c980-1b4e-4edb-922b-f153cb406bce",
      "name": "ğŸ” Researcher Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -23312,
        8120
      ],
      "credentials": {
        "openAiApi": {
          "id": "Oh3Rnj32fETJUF9U",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ {\n  book_id: $('ğŸ” Chapter Loop').first().json.book_id,\n  current_chapter: $('ğŸ” Chapter Loop').first().json.current_chapter,\n  current_chapter_index: $('ğŸ” Chapter Loop').first().json.current_chapter_index,\n  research_notes: $json.choices[0].message.content,\n  blueprint: $('ğŸ” Chapter Loop').first().json.blueprint,\n  target_audience: $('ğŸ” Chapter Loop').first().json.target_audience\n} }}",
        "options": {}
      },
      "id": "8eafdd4c-fc9f-435f-8eaa-9d8b101761e3",
      "name": "ğŸ’¾ Store Research",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -23088,
        8120
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"temperature\": 0.7,\n  \"max_tokens\": 6000,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Du bist \\\"The Writer\\\" - ein erfahrener Technical Author fÃ¼r das WPI.\\n\\n## WPI Tone of Voice\\n- Klar und prÃ¤zise, keine Floskeln\\n- Pragmatisch und praxisorientiert\\n- Respektvoll gegenÃ¼ber dem Leser\\n- Analogien und Beispiele aus der echten Welt\\n- Aktive Sprache, direkte Anrede (\\\"Du\\\")\\n\\n## Struktur pro Kapitel\\n1. **Einleitung** (1 Absatz): Warum ist das wichtig?\\n2. **Konzepte** (2-3 Seiten): Theorie verstÃ¤ndlich erklÃ¤rt\\n3. **Praxis** (3-4 Seiten): Code-Beispiele mit ErklÃ¤rungen\\n4. **Best Practices** (1 Seite): Do's and Don'ts\\n5. **Zusammenfassung** (1 Absatz): Key Takeaways\\n6. **Ãœbung** (1 Seite): Praktische Aufgabe\\n\\n## Code-Handling\\nWenn du Code-Beispiele brauchst, setze einen Platzhalter:\\n`<<CODE_REQUEST: Beschreibung was der Code tun soll>>`\\n\\nDer Coder-Agent wird diese spÃ¤ter mit validiertem Code ersetzen.\\n\\n## Output\\nSchreibe in Markdown mit deutschen Ãœberschriften.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Schreibe Kapitel {{ $json.current_chapter.number }}: \\\"{{ $json.current_chapter.title }}\\\"\\n\\n**Lernziele:**\\n{{ $json.current_chapter.learning_goals.map(g => '- ' + g).join('\\\\n') }}\\n\\n**Sections:**\\n{{ $json.current_chapter.sections.map(s => '- ' + s).join('\\\\n') }}\\n\\n**Recherche-Ergebnisse:**\\n{{ $json.research_notes }}\\n\\n**Zielgruppe:** {{ $json.target_audience }}\\n\\n**Praktische Ãœbung am Ende:** {{ $json.current_chapter.practical_exercise }}\\n\\nSchreibe das komplette Kapitel (ca. 10-15 Seiten / 3000-4000 WÃ¶rter).\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "b8e316c1-9b74-4ef3-9151-68c7efcbc73c",
      "name": "âœï¸ Writer Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -22864,
        8120
      ],
      "credentials": {
        "openAiApi": {
          "id": "Oh3Rnj32fETJUF9U",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const draft = $input.first().json.choices[0].message.content;\nconst prevData = $('ğŸ’¾ Store Research').first().json;\n\n// Extract CODE_REQUEST placeholders\nconst codeRequests = [];\nconst regex = /<<CODE_REQUEST:\\s*(.+?)>>/g;\nlet match;\n\nwhile ((match = regex.exec(draft)) !== null) {\n  codeRequests.push({\n    placeholder: match[0],\n    description: match[1].trim()\n  });\n}\n\nreturn {\n  json: {\n    ...prevData,\n    draft_content: draft,\n    code_requests: codeRequests,\n    has_code_requests: codeRequests.length > 0\n  }\n};"
      },
      "id": "5621a806-5733-40d4-9fca-50593b63e3c6",
      "name": "ğŸ“ Extract Code Requests",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -22640,
        8048
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-code",
              "leftValue": "={{ $json.has_code_requests }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6987f418-61b0-4417-abd9-be63849a9735",
      "name": "ğŸ”€ Code Needed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -22416,
        8048
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"temperature\": 0.2,\n  \"max_tokens\": 4000,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Du bist \\\"The Coder\\\" - ein Senior Developer, der Code-Beispiele fÃ¼r FachbÃ¼cher erstellt.\\n\\n## Regeln\\n1. Schreibe sauberen, lesbaren Code\\n2. FÃ¼ge hilfreiche Kommentare hinzu\\n3. Halte Beispiele kurz aber vollstÃ¤ndig\\n4. Verwende moderne Syntax (ES6+, aktuelle Framework-Versionen)\\n5. Behandle Edge Cases\\n\\n## Output-Format\\nFÃ¼r jede Code-Anfrage, antworte mit:\\n\\n```\\n### [Beschreibung]\\n```[sprache]\\n// Code hier\\n```\\n**ErklÃ¤rung:** Kurze ErklÃ¤rung was der Code tut.\\n```\\n\\nWenn der Code einen Fehler enthÃ¤lt, korrigiere ihn selbst.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Erstelle Code-Beispiele fÃ¼r folgende Anfragen:\\n\\n{{ $json.code_requests.map((cr, i) => `${i+1}. ${cr.description}`).join('\\\\n') }}\\n\\n**Kontext:** Kapitel \\\"{{ $json.current_chapter.title }}\\\" aus dem Buch \\\"{{ $json.blueprint.title }}\\\"\\n**Zielgruppe:** {{ $json.target_audience }}\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "b47468a5-27b3-4a3f-939e-10e1b442a8d4",
      "name": "ğŸ’» Coder Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -22192,
        7952
      ],
      "credentials": {
        "openAiApi": {
          "id": "Oh3Rnj32fETJUF9U",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prevData = $('ğŸ“ Extract Code Requests').first().json;\nconst codeResponse = $input.first().json.choices[0].message?.content || '';\n\n// Replace placeholders with actual code\nlet finalDraft = prevData.draft_content;\n\n// Simple replacement - in production, use more sophisticated matching\nprevData.code_requests.forEach((req, index) => {\n  // Find the corresponding code block in the response\n  const codeBlocks = codeResponse.match(/```[\\s\\S]*?```/g) || [];\n  if (codeBlocks[index]) {\n    finalDraft = finalDraft.replace(req.placeholder, codeBlocks[index]);\n  }\n});\n\nreturn {\n  json: {\n    ...prevData,\n    draft_content: finalDraft,\n    code_validated: true\n  }\n};"
      },
      "id": "3659d97c-dfaf-45f4-94c6-98cc181029f7",
      "name": "ğŸ”— Merge Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -21968,
        7952
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"temperature\": 0.3,\n  \"max_tokens\": 3000,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Du bist \\\"The ISO Editor\\\" - ein Quality Gate fÃ¼r WPI-Inhalte.\\n\\n## Deine Aufgaben\\n1. PrÃ¼fe ob alle Lernziele abgedeckt sind\\n2. PrÃ¼fe Konsistenz zwischen Text und Code\\n3. PrÃ¼fe didaktische QualitÃ¤t\\n4. Vergib einen Score (0-100)\\n5. Generiere 5 PrÃ¼fungsfragen\\n\\n## Bewertungskriterien\\n- VollstÃ¤ndigkeit der Lernziele: 30 Punkte\\n- Klarheit der ErklÃ¤rungen: 25 Punkte\\n- Code-QualitÃ¤t: 20 Punkte\\n- Didaktischer Aufbau: 15 Punkte\\n- Ãœbung sinnvoll: 10 Punkte\\n\\n## Output-Format (JSON)\\n```json\\n{\\n  \\\"score\\\": 85,\\n  \\\"feedback\\\": {\\n    \\\"strengths\\\": [\\\"...\\\", \\\"...\\\"],\\n    \\\"improvements\\\": [\\\"...\\\", \\\"...\\\"]\\n  },\\n  \\\"approved\\\": true,\\n  \\\"exam_questions\\\": [\\n    {\\n      \\\"question\\\": \\\"Frage?\\\",\\n      \\\"options\\\": [\\\"A) ...\\\", \\\"B) ...\\\", \\\"C) ...\\\", \\\"D) ...\\\"],\\n      \\\"correct\\\": \\\"B\\\",\\n      \\\"explanation\\\": \\\"Warum B richtig ist.\\\"\\n    }\\n  ]\\n}\\n```\\n\\nWenn score < 90, setze \\\"approved\\\": false und gib konkretes Feedback.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"PrÃ¼fe folgendes Kapitel:\\n\\n**Kapitel {{ $json.current_chapter.number }}:** {{ $json.current_chapter.title }}\\n\\n**Lernziele:**\\n{{ $json.current_chapter.learning_goals.map(g => '- ' + g).join('\\\\n') }}\\n\\n**Inhalt:**\\n{{ $json.draft_content }}\\n\\nBewerte das Kapitel und generiere 5 PrÃ¼fungsfragen. Antworte NUR mit JSON.\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "4f8bcf92-8bba-4ff6-ad68-28c45267a1d5",
      "name": "ğŸ” Editor Agent (QA)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -21520,
        8048
      ],
      "credentials": {
        "openAiApi": {
          "id": "Oh3Rnj32fETJUF9U",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json.choices[0].message.content;\nconst prevData = $('ğŸ”— Merge Code').first()?.json || $('ğŸ“ Extract Code Requests').first().json;\n\n// Parse editor response\nlet editorResult;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  editorResult = JSON.parse(jsonStr.trim());\n} catch (e) {\n  editorResult = {\n    score: 85,\n    approved: true,\n    feedback: { strengths: [], improvements: [] },\n    exam_questions: []\n  };\n}\n\nreturn {\n  json: {\n    ...prevData,\n    editor_score: editorResult.score,\n    editor_feedback: editorResult.feedback,\n    editor_approved: editorResult.approved,\n    exam_questions: editorResult.exam_questions,\n    revision_count: (prevData.revision_count || 0) + 1\n  }\n};"
      },
      "id": "acc159cf-7b7d-4945-8c84-74d7dccc9a2d",
      "name": "ğŸ“Š Parse Editor Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -21296,
        8048
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "approved",
              "leftValue": "={{ $json.editor_approved }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "5a1b1c76-7eb3-4461-9801-ac4d95e548c2",
      "name": "ğŸ”€ Quality OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -21072,
        8048
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "max-revisions",
              "leftValue": "={{ $json.revision_count }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "41d59870-a56d-4f8f-9905-f33b2d8ffe1c",
      "name": "ğŸ”€ Max Revisions?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -20848,
        8432
      ]
    },
    {
      "parameters": {
        "jsCode": "// Collect all completed chapters\nconst chapters = $input.all().map(item => ({\n  chapter_number: item.json.current_chapter.number,\n  title: item.json.current_chapter.title,\n  content: item.json.draft_content,\n  exam_questions: item.json.exam_questions,\n  score: item.json.editor_score\n}));\n\n// Sort by chapter number\nchapters.sort((a, b) => a.chapter_number - b.chapter_number);\n\n// Create final book markdown\nlet bookMarkdown = `# ${$input.first().json.blueprint.title}\\n\\n`;\nbookMarkdown += `*${$input.first().json.blueprint.subtitle || ''}*\\n\\n`;\nbookMarkdown += `---\\n\\n`;\n\nchapters.forEach(ch => {\n  bookMarkdown += ch.content + '\\n\\n---\\n\\n';\n});\n\n// Collect all exam questions\nconst allQuestions = chapters.flatMap(ch => \n  ch.exam_questions.map(q => ({\n    ...q,\n    chapter: ch.chapter_number\n  }))\n);\n\nreturn {\n  json: {\n    book_id: $input.first().json.book_id,\n    title: $input.first().json.blueprint.title,\n    final_markdown: bookMarkdown,\n    exam_questions: allQuestions,\n    chapter_scores: chapters.map(ch => ({ chapter: ch.chapter_number, score: ch.score })),\n    average_score: chapters.reduce((sum, ch) => sum + ch.score, 0) / chapters.length,\n    completed_at: new Date().toISOString()\n  }\n};"
      },
      "id": "4b36da4a-a077-401b-bb22-db5c6e15a155",
      "name": "ğŸ“š Compile Book",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -23328,
        9072
      ]
    },
    {
      "parameters": {
        "operation": "text"
      },
      "id": "125b9c4b-d75c-41ce-9261-18379ff5ea51",
      "name": "ğŸ“„ Convert Markdown",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -23120,
        8816
      ]
    },
    {
      "parameters": {
        "fileName": "=/tmp/wpi-books/{{ $json.book_id }}.md",
        "options": {}
      },
      "id": "cbe8426c-6b19-4dcf-b93a-d2613583be21",
      "name": "ğŸ’¾ Save Markdown",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        -22864,
        8832
      ]
    },
    {
      "parameters": {
        "operation": "json"
      },
      "id": "ad4d9db0-78cd-4e76-98fe-c9e62efc8516",
      "name": "ğŸ“„ Convert Questions",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -23072,
        9008
      ]
    },
    {
      "parameters": {
        "fileName": "=/tmp/wpi-books/{{ $json.book_id }}_exam_questions.json",
        "options": {}
      },
      "id": "08f9ea0a-7f9f-419c-b4ba-b55530a77e23",
      "name": "ğŸ’¾ Save Exam Questions",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        -22848,
        8992
      ]
    },
    {
      "parameters": {
        "fromEmail": "content-factory@wpi.org",
        "toEmail": "hennadii.shvedko@gmail.com",
        "subject": "=âœ… Book Complete: {{ $json.title }}",
        "html": "=<h1>ğŸ“š Buch fertiggestellt!</h1>\n<p><strong>{{ $json.title }}</strong></p>\n<p>Durchschnittlicher Quality Score: <strong>{{ Math.round($json.average_score) }}/100</strong></p>\n<p>Generierte PrÃ¼fungsfragen: <strong>{{ $json.exam_questions.length }}</strong></p>\n<h3>Chapter Scores:</h3>\n<ul>\n{{ $json.chapter_scores.map(cs => `<li>Kapitel ${cs.chapter}: ${cs.score}/100</li>`).join('') }}\n</ul>\n<p>Die Dateien wurden gespeichert und sind bereit fÃ¼r das Review.</p>",
        "options": {}
      },
      "id": "bc01ce79-6a62-46ac-9475-a35d357e1870",
      "name": "ğŸ“§ Notify Completion",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -23072,
        9296
      ],
      "webhookId": "0b89de68-70d6-4dbf-b11c-01879d8b8687",
      "credentials": {
        "smtp": {
          "id": "OjlJbmPfeYsQ6qw1",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "content": "## WPI AI Content Factory PoC\n\n### Workflow Ãœbersicht\nDieser Workflow demonstriert die Multi-Agenten-Architektur:\n\n1. **ğŸ“¥ Input**: Product Definition via Form\n2. **ğŸ—ï¸ Architect**: Erstellt Blueprint/TOC\n3. **â¸ï¸ Human Approval**: Experte prÃ¼ft Blueprint\n4. **ğŸ” Chapter Loop**: FÃ¼r jedes Kapitel:\n   - ğŸ” Researcher: Fakten sammeln\n   - âœï¸ Writer: Content erstellen\n   - ğŸ’» Coder: Code generieren\n   - ğŸ” Editor: Quality Check\n5. **ğŸ“š Output**: Fertiges Buch + Exam Questions\n\n### Konfiguration\n- OpenAI API Key in Credentials eintragen\n- Email-Settings anpassen\n- Output-Pfade konfigurieren",
        "height": 400,
        "width": 340
      },
      "id": "f9f11055-dd11-4c62-b8c8-5f0764d1c8ff",
      "name": "ğŸ“ Info",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -25450,
        8432
      ]
    },
    {
      "parameters": {},
      "id": "ea881d4a-37f6-40b0-8314-17239e38588b",
      "name": "â­ï¸ Skip Code",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -21968,
        8288
      ]
    },
    {
      "parameters": {
        "mode": "mergeByPosition"
      },
      "id": "37ea100a-998f-403f-b1f3-e33177dbec2a",
      "name": "ğŸ”€ Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -21744,
        8048
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸ“¥ Book Request Form": {
      "main": [
        [
          {
            "node": "ğŸ”§ Initialize BookState",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Initialize BookState": {
      "main": [
        [
          {
            "node": "ğŸ—ï¸ Architect Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—ï¸ Architect Agent": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Parse Blueprint",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Parse Blueprint": {
      "main": [
        [
          {
            "node": "ğŸ“§ Send for Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Send for Approval": {
      "main": [
        [
          {
            "node": "â¸ï¸ Wait for Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â¸ï¸ Wait for Approval": {
      "main": [
        [
          {
            "node": "ğŸ”€ Approved?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Approved?": {
      "main": [
        [
          {
            "node": "ğŸ“‘ Prepare Chapters",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ—ï¸ Architect Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‘ Prepare Chapters": {
      "main": [
        [
          {
            "node": "ğŸ” Chapter Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Chapter Loop": {
      "main": [
        [
          {
            "node": "ğŸ“š Compile Book",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” Researcher Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Researcher Agent": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Store Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ Store Research": {
      "main": [
        [
          {
            "node": "âœï¸ Writer Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœï¸ Writer Agent": {
      "main": [
        [
          {
            "node": "ğŸ“ Extract Code Requests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Extract Code Requests": {
      "main": [
        [
          {
            "node": "ğŸ”€ Code Needed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Code Needed?": {
      "main": [
        [
          {
            "node": "ğŸ’» Coder Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â­ï¸ Skip Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’» Coder Agent": {
      "main": [
        [
          {
            "node": "ğŸ”— Merge Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”— Merge Code": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â­ï¸ Skip Code": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ”€ Merge": {
      "main": [
        [
          {
            "node": "ğŸ” Editor Agent (QA)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Editor Agent (QA)": {
      "main": [
        [
          {
            "node": "ğŸ“Š Parse Editor Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Parse Editor Result": {
      "main": [
        [
          {
            "node": "ğŸ”€ Quality OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Quality OK?": {
      "main": [
        [
          {
            "node": "ğŸ” Chapter Loop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”€ Max Revisions?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Max Revisions?": {
      "main": [
        [
          {
            "node": "âœï¸ Writer Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” Chapter Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“š Compile Book": {
      "main": [
        [
          {
            "node": "ğŸ“„ Convert Markdown",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“„ Convert Questions",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“§ Notify Completion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“„ Convert Markdown": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Save Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“„ Convert Questions": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Save Exam Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "f2a25a8d-928a-48d3-b19c-6aed901e08ed",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b68c468f2753a5e21ae721b564973cd5aea893d803a833777daaeebe7bcdeb1b"
  },
  "id": "JyLMBG9nMV995HBw",
  "tags": [
    {
      "updatedAt": "2026-01-16T14:23:01.367Z",
      "createdAt": "2026-01-16T14:23:01.367Z",
      "id": "DYdRGNhTBTmphdcj",
      "name": "PoC"
    },
    {
      "updatedAt": "2026-01-16T14:23:01.422Z",
      "createdAt": "2026-01-16T14:23:01.422Z",
      "id": "RyqQ0gpkTnVL0fNU",
      "name": "AI"
    },
    {
      "updatedAt": "2026-01-16T14:23:01.430Z",
      "createdAt": "2026-01-16T14:23:01.430Z",
      "id": "VS8zmwloWJRDKGyi",
      "name": "Content Factory"
    },
    {
      "updatedAt": "2026-01-16T14:23:01.440Z",
      "createdAt": "2026-01-16T14:23:01.440Z",
      "id": "tEbTp0XPKIb0akiB",
      "name": "WPI"
    }
  ]
}