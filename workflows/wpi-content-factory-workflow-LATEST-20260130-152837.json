{
  "name": "WPI AI Content Factory - Syllabus Driven (Full)",
  "nodes": [
    {
      "parameters": {
        "path": "3d9430f4-c69d-4392-bae9-70bef5444575",
        "formTitle": "WPI Book Generator",
        "formDescription": "AI-gest√ºtzte Erstellung von Fachb√ºchern basierend auf Syllabus-Domains. Jede Domain wird zu einem Kapitel.",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Syllabus",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "WPI Web Development Professional (WPI-WEB-DEV-2025)"
                  }
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "Generation Strategy",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "By Domain"
                  },
                  {
                    "option": "By Topic"
                  }
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "Target Audience",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "Absolute Beginners"
                  },
                  {
                    "option": "Junior Developers"
                  },
                  {
                    "option": "Mid-Level Professionals"
                  },
                  {
                    "option": "Senior Experts"
                  }
                ]
              },
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "id": "d6a1a8fd-6a4b-4672-9add-8567847d9e24",
      "name": "üì• Book Request Form",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.1,
      "position": [
        -33600,
        12040
      ],
      "webhookId": "3d9430f4-c69d-4392-bae9-70bef5444575"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ (function() {\n  const formData = $('üì• Book Request Form').first().json;\n  const syllabusSelection = formData['Syllabus'] || '';\n  \n  // Parse syllabus ID from format: 'Name (syllabus-xxxxx)'\n  // Example: 'WPI Web Development (syllabus-1738051200123)'\n  const match = syllabusSelection.match(/\\(([^)]+)\\)/);\n  const syllabusId = match ? match[1] : null;\n  \n  if (!syllabusId) {\n    throw new Error('Invalid syllabus selection. Expected format: Name (syllabus-id)');\n  }\n  \n  const strategy = formData['Generation Strategy'] || 'By Domain';\n  \n  return {\n    syllabus_id: syllabusId,\n    syllabus_name: syllabusSelection.split('(')[0].trim(),\n    generation_strategy: strategy,\n    target_audience: formData['Target Audience'] || 'Mid-Level Professionals'\n  };\n})() }}",
        "options": {}
      },
      "id": "4b337324-aefc-4540-be44-5840c284abe9",
      "name": "üîç Extract Syllabus ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33376,
        12040
      ],
      "notes": "Parses syllabus ID from the form dropdown selection"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://mcp-standards:3002/syllabuses/{{ $json.syllabus_id }}/activate",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "b3aae1d1-8bc3-4f89-96eb-0f6fb0960727",
      "name": "üîÑ Activate Syllabus",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -33152,
        12040
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "notes": "Activates the selected syllabus in mcp-standards for MCP tools to use"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "route-by-domain",
              "leftValue": "={{ $('üîç Extract Syllabus ID').first().json.generation_strategy }}",
              "rightValue": "By Domain",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fd2e5127-4a5d-42a7-a823-7001755af4e5",
      "name": "üîÄ Route by Strategy",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -32928,
        12040
      ]
    },
    {
      "parameters": {
        "url": "http://mcp-standards:3002/syllabus/domains",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "5489fc41-55e1-4f4b-b07e-615e05e7a9cc",
      "name": "üìö Fetch Syllabus Domains",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -32704,
        11944
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "http://mcp-standards:3002/syllabus/topics",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "bfbdc35d-fd00-4f5e-8879-32e6a4c32b84",
      "name": "üìë Fetch Syllabus Topics",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -32704,
        12136
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ (function() {\n  const formData = $('üì• Book Request Form').first().json;\n  const extractedData = $('üîç Extract Syllabus ID').first().json;\n  const strategy = extractedData.generation_strategy;\n  const data = $json;\n  \n  // Determine if we're using domains or topics\n  const isDomainMode = strategy === 'By Domain';\n  \n  return {\n    book_id: 'book-' + extractedData.syllabus_id + '-' + Date.now(),\n    syllabus_id: extractedData.syllabus_id,\n    syllabus_name: data.syllabus_name || 'Unknown Syllabus',\n    generation_strategy: strategy,\n    target_audience: extractedData.target_audience,\n    total_items: isDomainMode ? (data.total_chapters || 0) : (data.total_topics || 0),\n    items: isDomainMode ? (data.chapters || []) : (data.topics || []),\n    status: 'initialized',\n    created_at: new Date().toISOString()\n  };\n})() }}",
        "options": {}
      },
      "id": "598e4354-b9c5-4879-ba94-3196c1045d25",
      "name": "üîß Initialize BookState",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -32480,
        12040
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-standards:3002/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'get_syllabus_section',\n  arguments: {\n    domain_id: $json.chapters[0]?.domain_id || $json.items[0]?.domain_id || $json.items[0]?.topic_id || 'D1',\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "e89561e9-1446-45aa-9415-faae6e6be3eb",
      "name": "üìö MCP: Get Syllabus Section",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -32256,
        11944
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-research:3003/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'hybrid_search',\n  arguments: {\n    query: $('üîß Initialize BookState').first().json.syllabus_name + ' ' + $('üîß Initialize BookState').first().json.chapters.map(function(c) { return c.title; }).join(' '),\n    limit: 10,\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "54a2d447-c9f5-45a3-b8f3-4e2840d1f957",
      "name": "üîç MCP: Search Knowledge Base",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -32256,
        12136
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Combine syllabus and research context\nconst bookState = $('üîß Initialize BookState').first().json;\n\n// Get syllabus section (from MCP-Standards)\nlet syllabusContext = null;\ntry {\n  const syllabusResponse = $('üìö MCP: Get Syllabus Section').first().json;\n  if (syllabusResponse.body && !syllabusResponse.body.error) {\n    const content = syllabusResponse.body.content?.[0]?.text;\n    syllabusContext = content ? JSON.parse(content) : null;\n  }\n} catch (e) {\n  console.log('Syllabus fetch failed, continuing without:', e.message);\n}\n\n// Get research context (from MCP-Research / Qdrant)\nlet researchContext = [];\ntry {\n  const researchResponse = $('üîç MCP: Search Knowledge Base').first().json;\n  if (researchResponse.body && !researchResponse.body.error) {\n    const content = researchResponse.body.content?.[0]?.text;\n    const parsed = content ? JSON.parse(content) : null;\n    researchContext = parsed?.results || [];\n  }\n} catch (e) {\n  console.log('Research fetch failed, continuing without:', e.message);\n}\n\nreturn {\n  json: {\n    ...bookState,\n    syllabus_context: syllabusContext,\n    research_context: researchContext,\n    has_syllabus: !!syllabusContext,\n    has_research: researchContext.length > 0\n  }\n};"
      },
      "id": "38adaa00-8042-4442-89e6-1cf3db086700",
      "name": "üîÄ Merge MCP Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32032,
        12040
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.3,\n  max_tokens: 4000,\n  messages: [\n    {\n      role: 'system',\n      content: 'Du bist \"The Architect\" - ein erfahrener Didaktik-Experte f√ºr technische Fachb√ºcher.\\n\\nDeine Aufgabe:\\n1. Analysiere die Syllabus-Struktur (Kapitel/Topics sind bereits vordefiniert!)\\n2. Nutze den Kontext aus der Knowledge Base\\n3. Erstelle detaillierte Lernziele und Sections\\n4. Definiere klare Lernziele f√ºr jedes Kapitel (ISO 17024 konform)\\n\\nWICHTIG: Die Kapitelstruktur ist bereits vorgegeben!\\nDu sollst NUR die Details ausarbeiten, nicht die Struktur √§ndern.\\n\\nRegeln:\\n- Jedes Kapitel sollte 10-15 Seiten umfassen\\n- Beginne mit Grundlagen, steigere die Komplexit√§t\\n- Jedes Kapitel endet mit einer praktischen √úbung\\n- Ber√ºcksichtige die Zielgruppe bei der Tiefe\\n- Lernziele m√ºssen messbar und √ºberpr√ºfbar sein\\n\\nOutput-Format: JSON\\n```json\\n{\\n  \"title\": \"Buchtitel (aus Syllabus-Name)\",\\n  \"subtitle\": \"Untertitel\",\\n  \"iso_alignment\": {\\n    \"syllabus_id\": \"ID\",\\n    \"covered_domains\": [\"D1\", \"D2\"]\\n  },\\n  \"chapters\": [\\n    {\\n      \"number\": 1,\\n      \"domain_id\": \"D1\",\\n      \"title\": \"Titel\",\\n      \"learning_goals\": [\"Lernziel 1 (Bloom: K2)\", \"Lernziel 2 (Bloom: K3)\"],\\n      \"syllabus_mapping\": [\"LO-001\", \"LO-002\"],\\n      \"sections\": [\"Section 1\", \"Section 2\"],\\n      \"estimated_pages\": 12,\\n      \"practical_exercise\": \"Beschreibung der √úbung\"\\n    }\\n  ]\\n}\\n```'\n    },\n    {\n      role: 'user',\n      content: (function() {\n        const items = $json.items || $json.chapters || [];\n        const totalItems = $json.total_items || $json.total_chapters || items.length;\n        const strategy = $json.generation_strategy || 'By Domain';\n        \n        let itemsDescription = items.map(function(item, index) {\n          if (item.chapter_number) {\n            return 'Kapitel ' + item.chapter_number + ': ' + item.title + '\\n  - Domain ID: ' + item.domain_id + '\\n  - Beschreibung: ' + (item.description || 'N/A') + '\\n  - Topics: ' + (item.topics || []).map(function(t) { return t.title; }).join(', ') + '\\n  - Learning Objectives: ' + (item.learning_objectives || []).length + ' St√ºck';\n          } else {\n            return 'Topic ' + item.topic_number + ': ' + item.title + '\\n  - Topic ID: ' + item.topic_id + '\\n  - Domain: ' + item.domain_name + ' (' + item.domain_id + ')\\n  - Learning Objectives: ' + (item.learning_objectives || []).length + ' St√ºck' + (item.subtopics && item.subtopics.length > 0 ? '\\n  - Subtopics: ' + item.subtopics.length + ' St√ºck' : '');\n          }\n        }).join('\\n\\n');\n        \n        return 'Erstelle das Inhaltsverzeichnis basierend auf der vorgegebenen Syllabus-Struktur:\\n\\n**Syllabus:** ' + $json.syllabus_name + ' (ID: ' + $json.syllabus_id + ')\\n**Zielgruppe:** ' + $json.target_audience + '\\n**Generierungsstrategie:** ' + strategy + '\\n**Anzahl Items:** ' + totalItems + '\\n\\n**VORDEFINIERTE STRUKTUR:**\\n' + itemsDescription + '\\n\\n' + ($json.has_syllabus ? '**Syllabus-Kontext:**\\n' + JSON.stringify($json.syllabus_context, null, 2) : '') + '\\n\\n' + ($json.has_research ? '**Relevanter Kontext aus Knowledge Base:**\\n' + $json.research_context.slice(0, 5).map(function(r) { return '- ' + (r.text || '').substring(0, 200) + '...'; }).join('\\n') : '') + '\\n\\nWICHTIG: Behalte die Struktur bei! F√ºge nur Lernziele, Sections und √úbungen hinzu.\\n\\nAntworte NUR mit dem JSON, keine Erkl√§rungen.';\n      })()\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "c3342b49-23c5-47ff-a0f4-a2985d5f0c7f",
      "name": "üèóÔ∏è Architect Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -31808,
        12040
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse the AI response and extract JSON\nconst response = $input.first().json.choices[0].message.content;\n\n// Try to extract JSON from the response\nlet blueprint;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  blueprint = JSON.parse(jsonStr.trim());\n} catch (e) {\n  throw new Error('Failed to parse blueprint JSON: ' + e.message);\n}\n\n// Get the previous state\nconst prevState = $('üîÄ Merge MCP Context').first().json;\n\n// Get original items (could be chapters or topics)\nconst originalItems = prevState.items || prevState.chapters || [];\n\n// Merge blueprint chapters with original data\nconst mergedChapters = blueprint.chapters.map((bpCh, index) => {\n  const originalItem = originalItems[index] || {};\n  return {\n    ...bpCh,\n    number: bpCh.number || index + 1,\n    domain_id: originalItem.domain_id || bpCh.domain_id,\n    topic_id: originalItem.topic_id,\n    topic_number: originalItem.topic_number,\n    original_learning_objectives: originalItem.learning_objectives || [],\n    topics: originalItem.topics || bpCh.topics || [],\n    subtopics: originalItem.subtopics || [],\n    weight: originalItem.weight,\n    prerequisites: originalItem.prerequisites || []\n  };\n});\n\nblueprint.chapters = mergedChapters;\n\nreturn {\n  json: {\n    ...prevState,\n    blueprint: blueprint,\n    status: 'blueprint_ready'\n  }\n};"
      },
      "id": "f83a126d-6eda-45ca-8e3e-54dffb5fe6cd",
      "name": "üìã Parse Blueprint",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -31584,
        12040
      ]
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=http://mcp-standards:3002/chapters/{{ $('üîß Initialize BookState').first().json.book_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "bed066c4-d756-434e-b520-7d6b1eb50cb4",
      "name": "üóëÔ∏è Clear Chapter Accumulator",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -31360,
        12040
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Get current state\nconst state = $('üìã Parse Blueprint').first().json;\nconst chapters = state.blueprint.chapters;\nconst bookId = state.book_id;\n\nconsole.log('Preparing chapters for book:', bookId, 'Total chapters:', chapters.length);\n\n// Return chapters as array for loop\nreturn chapters.map((chapter, index) => ({\n  json: {\n    ...state,\n    current_chapter: chapter,\n    current_chapter_index: index,\n    total_chapters: chapters.length\n  }\n}));"
      },
      "id": "e82455ef-dbca-4531-af77-6c58d3c174d8",
      "name": "üìë Prepare Chapters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -31136,
        12040
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "0298a38a-ba47-4f1f-9f9a-e6a2e06afbea",
      "name": "üîÅ Chapter Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -30912,
        12088
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-research:3003/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'hybrid_search',\n  arguments: {\n    query: $json.current_chapter.title + ' ' + ($json.current_chapter.learning_goals || []).join(' '),\n    filter_metadata: {\n      domain_id: $json.current_chapter.domain_id || $json.current_chapter.topic_id || undefined\n    },\n    limit: 5,\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "793511d8-1c32-4abe-b6cc-ba09cd4ff7fc",
      "name": "üîç MCP: Chapter Research",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -30688,
        11752
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-standards:3002/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'get_syllabus_section',\n  arguments: {\n    domain_id: $('üîÅ Chapter Loop').first().json.current_chapter.domain_id || $('üîÅ Chapter Loop').first().json.current_chapter.topic_id || 'D1',\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "f9b11b76-44af-4b7f-8107-fae06dd1aabc",
      "name": "üìö MCP: Get Chapter LOs",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -30688,
        12328
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "id": "5bc54957-7dae-4584-9cfa-f264e966953f",
      "name": "üîÄ Merge MCP Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -30464,
        11752
      ]
    },
    {
      "parameters": {},
      "id": "3257cef4-303f-4b49-bf18-2f9513216637",
      "name": "üîÄ Add Chapter Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -30240,
        11824
      ]
    },
    {
      "parameters": {
        "jsCode": "// Reset revision counter for this chapter\nconst staticData = $getWorkflowStaticData('global');\nstaticData.revision_count = 0;\n\n// Get all input items - merged from: MCP Research, MCP Syllabus, Chapter Loop\nconst allItems = $input.all();\n\n// Find chapter data, research results, and syllabus LOs from merged inputs\nlet chapterResearch = [];\nlet syllabusLOs = [];\nlet chapterData = null;\n\nfor (const item of allItems) {\n  const json = item.json;\n  \n  // Check if this is chapter data from the loop (has current_chapter)\n  if (json.current_chapter && json.blueprint) {\n    chapterData = json;\n    continue;\n  }\n  \n  // Check if this is an MCP HTTP response (has body.content structure)\n  if (json.body?.content?.[0]?.text) {\n    try {\n      const parsed = JSON.parse(json.body.content[0].text);\n      \n      // Check for research results (has results_count or query field)\n      if (parsed.query !== undefined || parsed.results_count !== undefined) {\n        chapterResearch = parsed.results || [];\n      }\n      // Check for syllabus section data\n      else if (parsed.results && parsed.count !== undefined) {\n        syllabusLOs = parsed.results || [];\n      }\n      else if (parsed.section || parsed.found || parsed.learning_objectives) {\n        syllabusLOs = parsed.learning_objectives || parsed.results || [];\n        if (parsed.section?.topics) {\n          for (const topic of parsed.section.topics) {\n            if (topic.learning_objectives) {\n              syllabusLOs = syllabusLOs.concat(topic.learning_objectives);\n            }\n          }\n        }\n      }\n    } catch (e) {\n      console.log('Failed to parse MCP response:', e.message);\n    }\n  }\n}\n\n// Verify we have chapter data\nif (!chapterData) {\n  throw new Error('Chapter data not found in merged inputs. Check workflow connections.');\n}\n\n// Merge original LOs from domain with fetched LOs\nconst allLOs = [...(chapterData.current_chapter.original_learning_objectives || []), ...syllabusLOs];\n\nreturn {\n  json: {\n    book_id: chapterData.book_id,\n    current_chapter: chapterData.current_chapter,\n    current_chapter_index: chapterData.current_chapter_index,\n    chapter_research: chapterResearch,\n    syllabus_learning_objectives: allLOs,\n    blueprint: chapterData.blueprint,\n    target_audience: chapterData.target_audience,\n    revision_count: 0\n  }\n};"
      },
      "id": "dc176ba6-f129-4e9c-9624-8b136669a55d",
      "name": "üíæ Merge Chapter Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -30016,
        11824
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.5,\n  max_tokens: 8000,\n  messages: [\n    {\n      role: 'system',\n      content: '# SYSTEM PROMPT: WPI STUDY GUIDE CHAPTER GENERATOR (v4.4 - MARKDOWN OUTPUT)\\n\\n## 1. ROLE & OBJECTIVE\\n\\nYou are the **\"WPI Technical Architect\"**, an expert educational content creator for high-level IT certifications (ISO 17024 standard).\\n\\nYour task is to generate a **Study Guide Chapter** in German using **MARKDOWN FORMAT** (NOT HTML!).\\n\\n### TARGET AUDIENCE PROFILE (The \"WPI Candidate\")\\n- **Persona:** Career-focused professionals (EQF Level 5/6). Time-constrained and highly motivated.\\n- **Goal:** Passing a rigorous exam and solving real-world architectural problems.\\n- **Mindset:** They hate \"fluff\" and marketing buzzwords. They value precision, density, and \"mechanic-first\" explanations.\\n\\n**CRITICAL:** Prioritize **DEPTH** over breadth. This is a study guide for professionals, not a blog post.\\n\\n## 2. STRICT EDITORIAL RULES (Editorial Guide V3.0)\\n\\n### A. The \"Deep Dive\" Mandate & Workload Calculation\\n- **Target Length:** Generate **3,000 to 3,500 words** of core content\\n- **Workload Calculation:** 40 Words = 1 Minute, round up to next 10 minutes\\n\\n### B. The \"Anti-Circular\" Definition Rule\\n- FORBIDDEN: Defining complex terms using other complex terms\\n- REQUIRED: Explain using simple analogies first\\n\\n### C. Tone & Style\\n- **Voice:** \"Professional-Instructive\". Neutral, factual.\\n- **PROHIBITED:** \"Du\", \"Sie\", \"Wir\" (Personal address). Use Passive or Imperative.\\n- **Acronyms:** First-Mention Rule (Write out fully on first use)\\n\\n### D. Bloom Level Interpretation (Apply Strictly)\\n- **(K1) Remember:** Define terms. Simple Recall.\\n- **(K2) Understand:** Explain concepts. Zero-to-Hero.\\n- **(K3) Apply:** Use scenarios. Show usage.\\n- **(K4) Analyze:** Diagnose errors. Debugging.\\n- **(K5) Evaluate:** Strategic comparison (Pros/Cons).\\n- **(K6) Create:** Design architectures. Coding.\\n\\n## 3. MARKDOWN OUTPUT STRUCTURE\\n\\n**IMPORTANT: Output MARKDOWN, NOT HTML!**\\n\\n```markdown\\n# TEIL [PART]: [TITLE]\\n\\n## Kapitel [NUMBER]: [CHAPTER_TITLE]\\n\\n**‚è±Ô∏è Workload:** ca. [MINUTES] Minuten\\n\\n*Syllabus-ID: [DOMAIN_ID]*\\n\\n---\\n\\n### Lernziele\\n\\n- LO-1: [Learning Objective 1]\\n- LO-2: [Learning Objective 2]\\n\\n---\\n\\n### Das Szenario\\n\\n> [Realistic business problem / technical failure as blockquote]\\n> [Build a \"Cliffhanger\" - do not solve yet]\\n\\n---\\n\\n### [Topic 1 Title]\\n\\n**üìñ Definition: [Term]**\\n\\n[Explanation...]\\n\\n#### [Subtopic]\\n\\n[Content with code blocks using triple backticks]\\n\\n```javascript\\n// Code example with language tag\\nconst example = \"code\";\\n```\\n\\n> **üí° Best Practice:** [Industry standard tip]\\n\\n> **‚ö†Ô∏è Pitfall:** [Common mistake with consequences]\\n\\n> **üöÄ Pro-Tip:** [Advanced efficiency hack]\\n\\n---\\n\\n### Fallstudie: L√∂sung\\n\\n[Explicitly resolve the scenario from above]\\n\\n---\\n\\n### Key Takeaways\\n\\n1. [Takeaway 1]\\n2. [Takeaway 2]\\n3. [Takeaway 3]\\n\\n---\\n\\n### Wissenscheck\\n\\n**Frage 1:** [Question text]\\n\\n> **Antwort:** [Answer]\\n\\n**Frage 2:** [Question text]\\n\\n> **Antwort:** [Answer]\\n\\n[Continue for 5-6 questions]\\n\\n---\\n\\n### Transfer-√úbung\\n\\n[Practical exercise or code challenge]\\n```\\n\\n## 4. CODE-HANDLING\\n\\nWhen code examples are needed, insert a placeholder:\\n<<CODE_REQUEST: [Description of what the code should do]>>\\n\\nThe Coder Agent will replace these with validated ES6+ code.\\n\\n**GENERATE CHAPTER IN MARKDOWN NOW.**'\n    },\n    {\n      role: 'user',\n      content: '## INPUT DATA FOR CHAPTER GENERATION\\n\\n**CURRENT CHAPTER:** ' + $json.current_chapter.number + ' of ' + $json.blueprint.chapters.length + '\\n**DOMAIN ID:** ' + ($json.current_chapter.domain_id || $json.current_chapter.topic_id || 'Unknown') + '\\n**CHAPTER TITLE:** ' + $json.current_chapter.title + '\\n\\n### LEARNING GOALS (from Architect):\\n' + ($json.current_chapter.learning_goals || []).map(function(g, i) { return '- LO-' + (i+1) + ': ' + g; }).join('\\n') + '\\n\\n**Sections to cover:**\\n' + ($json.current_chapter.sections || []).map(function(s) { return '- ' + s; }).join('\\n') + '\\n\\n' + ($json.syllabus_learning_objectives.length > 0 ? '### ISO 17024 SYLLABUS LEARNING OBJECTIVES:\\n' + $json.syllabus_learning_objectives.slice(0, 10).map(function(lo) { return '- ' + (lo.id || lo.content?.id || '') + ': ' + (lo.description || lo.content?.description || JSON.stringify(lo).substring(0, 100)); }).join('\\n') : '') + '\\n\\n' + ($json.chapter_research.length > 0 ? '### RAG_CONTENT (Internal Knowledge Base):\\n' + $json.chapter_research.slice(0, 5).map(function(r) { return '---\\n' + (r.text || '').substring(0, 500) + '...'; }).join('\\n') : '') + '\\n\\n### TARGET AUDIENCE: ' + $json.target_audience + '\\n\\n### PRACTICAL EXERCISE: ' + ($json.current_chapter.practical_exercise || 'Create a relevant hands-on exercise') + '\\n\\n---\\n\\n**EXECUTION INSTRUCTIONS:**\\n1. Generate 3,000-3,500 words of content IN MARKDOWN FORMAT\\n2. Calculate workload: words/40, round to next 10 minutes\\n3. Use proper Markdown syntax (headers, code blocks, blockquotes)\\n4. Follow Zero-to-Hero flow for each LO\\n5. Insert <<CODE_REQUEST: ...>> for code examples\\n6. Include all mandatory sections (Scenario, Content, Case Study, Takeaways, Quiz)\\n\\n**GENERATE THE CHAPTER IN MARKDOWN NOW.**'\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "2c39543b-effd-4c3b-a46b-04158253187c",
      "name": "‚úçÔ∏è WPI Technical Architect",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -29792,
        11824
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const draft = $input.first().json.choices[0].message.content;\n\n// Get base data from Merge Chapter Context\nlet prevData = $('üíæ Merge Chapter Context').first().json;\n\n// Get revision count from workflow static data\nconst staticData = $getWorkflowStaticData('global');\nlet revision_count = staticData.revision_count || 0;\n\n// Extract CODE_REQUEST placeholders\nconst codeRequests = [];\nconst regex = /<<CODE_REQUEST:\\s*(.+?)>>/g;\nlet match;\n\nwhile ((match = regex.exec(draft)) !== null) {\n  codeRequests.push({\n    placeholder: match[0],\n    description: match[1].trim()\n  });\n}\n\nreturn {\n  json: {\n    ...prevData,\n    draft_content: draft,\n    code_requests: codeRequests,\n    has_code_requests: codeRequests.length > 0,\n    revision_count: revision_count\n  }\n};"
      },
      "id": "a13df5d3-16cc-4c65-b19b-8cf1babaf5df",
      "name": "üìù Extract Code Requests",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -29568,
        11752
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-code",
              "leftValue": "={{ $json.has_code_requests }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "283db70d-87e8-4fb4-b881-3d3b0fb9762a",
      "name": "üîÄ Code Needed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -29344,
        11752
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.2,\n  max_tokens: 4000,\n  messages: [\n    {\n      role: 'system',\n      content: '## Your Identity\\nYou are the \"WPI Coder Agent,\" a Senior Full-Stack Engineer and technical author. Your goal is to generate high-quality, production-ready code examples for the WPI Syllabus Guide.\\n\\n## Core Responsibilities\\n1. **Follow the Tangibility Mandate:** For every technical topic, you MUST provide a complete, syntaktisch correct code block.\\n2. **Technical Standards:** Use modern syntax (ES6+ for JavaScript, HTML5, CSS3) and handle common edge cases.\\n3. **WPI Tone of Voice:** Use a \"Professional-Instructive\" voice. Avoid \"Du\" or \"Sie\" in technical instructions.\\n4. **Zero Fluff:** Provide maximum competence with no filler words.\\n\\n## Code Validation Requirements\\nYour code will be automatically validated by the MCP Coder service after generation:\\n- JavaScript/TypeScript: ESLint ES6+ strict validation\\n- HTML: Structure and accessibility validation\\n- CSS: Syntax validation\\n\\n## Best Practices\\n1. Use const/let, never var\\n2. Use arrow functions and template literals\\n3. Handle errors gracefully\\n4. Include edge case handling\\n5. Add meaningful comments (German)\\n6. Keep examples practical and production-ready\\n\\n## Output Format\\nF√ºr jede Code-Anfrage, antworte mit:\\n\\n### [Beschreibung]\\n```[sprache]\\n// Vollst√§ndiger, lauff√§higer Code\\n```\\n**Mechanik:** Kurze Erkl√§rung wie es funktioniert.\\n**Impact:** Warum ist dieser Ansatz wichtig?'\n    },\n    {\n      role: 'user',\n      content: 'Erstelle Code-Beispiele f√ºr folgende Anfragen:\\n\\n' + $json.code_requests.map(function(cr, i) { return (i+1) + '. ' + cr.description; }).join('\\n') + '\\n\\n**Kontext:** Kapitel \"' + $json.current_chapter.title + '\" aus dem Buch \"' + $json.blueprint.title + '\"\\n**Zielgruppe:** ' + $json.target_audience + '\\n\\n**WICHTIG:** Der Code wird automatisch validiert. Achte besonders auf:\\n- ES6+ Syntax (const/let, arrow functions, template literals)\\n- Keine ungenutzten Variablen\\n- Syntaktische Korrektheit\\n- Edge Case Handling'\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "bc02341d-6750-4824-8067-5a39674fc9b9",
      "name": "üíª WPI Coder Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -29120,
        11656
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prevData = $('üìù Extract Code Requests').first().json;\nconst codeResponse = $input.first().json.choices[0].message?.content || '';\n\n// Extract code blocks for validation\nconst codeBlocks = codeResponse.match(/```([\\w]*)\\n([\\s\\S]*?)```/g) || [];\nconst extractedCode = codeBlocks.map(block => {\n  const match = block.match(/```([\\w]*)\\n([\\s\\S]*?)```/);\n  return {\n    language: match[1] || 'javascript',\n    code: match[2].trim()\n  };\n});\n\n// Replace placeholders with actual code\nlet finalDraft = prevData.draft_content;\nprevData.code_requests.forEach((req, index) => {\n  if (codeBlocks[index]) {\n    finalDraft = finalDraft.replace(req.placeholder, codeBlocks[index]);\n  }\n});\n\nreturn {\n  json: {\n    ...prevData,\n    draft_content: finalDraft,\n    extracted_code: extractedCode,\n    raw_code_response: codeResponse,\n    code_validated: false\n  }\n};"
      },
      "id": "164b8b23-5faa-437e-a168-044263e39b24",
      "name": "üîó Merge Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -28896,
        11656
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-coder:3004/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ (function() {\n  const codeItems = $json.extracted_code || [];\n  if (codeItems.length === 0) {\n    return JSON.stringify({ name: 'validate_code_snippet', arguments: { code: '// no code', language: 'javascript' }});\n  }\n  const firstCode = codeItems[0];\n  const langMap = { 'js': 'javascript', 'ts': 'typescript', 'jsx': 'javascript', 'tsx': 'typescript' };\n  const lang = langMap[firstCode.language] || firstCode.language || 'javascript';\n  return JSON.stringify({\n    name: 'validate_code_snippet',\n    arguments: {\n      code: firstCode.code,\n      language: ['javascript', 'typescript', 'html', 'css', 'json'].includes(lang) ? lang : 'javascript',\n      strict_mode: true,\n      check_best_practices: false\n    }\n  });\n})() }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "a615e9b4-8b00-499e-a3fa-fb7f00b39385",
      "name": "üî¨ MCP: Validate Code",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -28672,
        11656
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const prevData = $('üîó Merge Code').first().json;\n\n// Parse validation result from MCP-Coder\nlet validationResult = { valid: true, errors: [], suggestions: [] };\ntry {\n  const valResp = $('üî¨ MCP: Validate Code').first().json;\n  if (valResp.body?.content?.[0]?.text) {\n    validationResult = JSON.parse(valResp.body.content[0].text);\n  }\n} catch (e) {\n  console.log('Code validation not available:', e.message);\n}\n\n// Get static data for retry count\nconst staticData = $getWorkflowStaticData('global');\nstaticData.code_retry_count = staticData.code_retry_count || 0;\n\nreturn {\n  json: {\n    ...prevData,\n    code_validation: validationResult,\n    code_validated: validationResult.valid,\n    code_errors: validationResult.errors || [],\n    code_suggestions: validationResult.suggestions || [],\n    code_retry_count: staticData.code_retry_count\n  }\n};"
      },
      "id": "090ef464-fad6-485a-b307-8c33af01ac82",
      "name": "üìä Parse Code Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -28448,
        11584
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "code-valid",
              "leftValue": "={{ $json.code_validated }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4cd3f3cb-9a8d-44b4-bc61-ef583b1f44f8",
      "name": "üîÄ Code Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -28224,
        11584
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "code-retry-limit",
              "leftValue": "={{ $json.code_retry_count }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "602636d8-27b5-4c00-afc2-47f44a92fb04",
      "name": "üîÄ Code Retry?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -28000,
        11512
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.1,\n  max_tokens: 4000,\n  messages: [\n    {\n      role: 'system',\n      content: '## Your Identity\\nYou are the \"WPI Coder Agent\" performing SELF-CORRECTION based on validation errors.\\n\\n## Your Task\\nThe code you previously generated failed validation. You MUST fix ALL errors reported by the validator.\\n\\n## Correction Strategy\\n1. Fix syntax errors first (blocking issues)\\n2. Apply ES6+ best practices (const/let, arrow functions, template literals)\\n3. Remove unused variables\\n4. Ensure all edge cases are handled\\n5. Maintain code readability and comments\\n\\n## Output Format\\nReturn the CORRECTED code in the same structure as before (with ```language blocks and descriptions).\\nDo NOT explain what you fixed - just provide the corrected code.'\n    },\n    {\n      role: 'user',\n      content: '**Validation Failed - Self-Correction Required**\\n\\n**Original Code:**\\n' + $json.raw_code_response + '\\n\\n**Validation Errors:**\\n' + JSON.stringify($json.code_errors, null, 2) + '\\n\\n**Suggestions:**\\n' + ($json.code_suggestions || []).join('\\n') + '\\n\\n**Retry Count:** ' + ($json.code_retry_count + 1) + ' / 2\\n\\nFix ALL errors and return the corrected code in the same format (```language blocks).'\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "869329a7-e848-4db9-8f16-021435aeb7c5",
      "name": "üîÑ WPI Coder Self-Correct",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -27776,
        11440
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Increment retry counter and merge corrected code\nconst staticData = $getWorkflowStaticData('global');\nstaticData.code_retry_count = (staticData.code_retry_count || 0) + 1;\n\nconst prevData = $('üìä Parse Code Validation').first().json;\nconst codeResponse = $input.first().json.choices[0].message?.content || '';\n\n// Extract code blocks for validation\nconst codeBlocks = codeResponse.match(/```([\\w]*)\\n([\\s\\S]*?)```/g) || [];\nconst extractedCode = codeBlocks.map(block => {\n  const match = block.match(/```([\\w]*)\\n([\\s\\S]*?)```/);\n  return {\n    language: match[1] || 'javascript',\n    code: match[2].trim()\n  };\n});\n\n// Re-merge into draft\nlet finalDraft = prevData.draft_content;\nconst originalCodeBlocks = prevData.draft_content.match(/```[\\s\\S]*?```/g) || [];\noriginalCodeBlocks.forEach((oldBlock, index) => {\n  if (codeBlocks[index]) {\n    finalDraft = finalDraft.replace(oldBlock, codeBlocks[index]);\n  }\n});\n\nreturn {\n  json: {\n    ...prevData,\n    draft_content: finalDraft,\n    extracted_code: extractedCode,\n    raw_code_response: codeResponse,\n    code_validated: false,\n    code_retry_count: staticData.code_retry_count\n  }\n};"
      },
      "id": "95f43fb1-be12-4fc0-a32e-6d07c969d916",
      "name": "üîó Merge Corrected Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -27552,
        11488
      ]
    },
    {
      "parameters": {},
      "id": "a0cdee77-ee3a-49ad-9c81-e27fdf2a072d",
      "name": "‚è≠Ô∏è Skip Validation",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -27776,
        11632
      ]
    },
    {
      "parameters": {},
      "id": "520afa03-bce3-4c66-b7c1-f87a622fad36",
      "name": "‚è≠Ô∏è Skip Code",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -27776,
        12040
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-standards:3002/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ (function() {\n  var draft = '';\n  try {\n    draft = $('üîó Merge Code').first().json.draft_content;\n  } catch (e) {\n    try {\n      draft = $('‚è≠Ô∏è Skip Code').first().json.draft_content || $('üìù Extract Code Requests').first().json.draft_content;\n    } catch (e2) {\n      draft = $('üìù Extract Code Requests').first().json.draft_content;\n    }\n  }\n  return JSON.stringify({\n    name: 'validate_iso_compliance',\n    arguments: {\n      content: draft.substring(0, 10000),\n      output_format: 'json'\n    }\n  });\n})() }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "c8fa2ba1-d333-44b6-bdee-2afb3479d594",
      "name": "üìã MCP: ISO Compliance Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -27552,
        11776
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ (function() {\n  var draft = '';\n  var prevData = {};\n  try {\n    prevData = $('üîó Merge Code').first().json;\n    draft = prevData.draft_content;\n  } catch (e) {\n    try {\n      prevData = $('‚è≠Ô∏è Skip Code').first().json || $('üìù Extract Code Requests').first().json;\n      draft = prevData.draft_content || $('üìù Extract Code Requests').first().json.draft_content;\n    } catch (e2) {\n      prevData = $('üìù Extract Code Requests').first().json;\n      draft = prevData.draft_content;\n    }\n  }\n  var isoCompliance = null;\n  try {\n    var isoResp = $('üìã MCP: ISO Compliance Check').first().json;\n    if (isoResp.body && isoResp.body.content && isoResp.body.content[0] && isoResp.body.content[0].text) {\n      isoCompliance = JSON.parse(isoResp.body.content[0].text);\n    }\n  } catch (e) {}\n  return JSON.stringify({\n    model: 'gpt-4o',\n    temperature: 0.2,\n    max_tokens: 4000,\n    messages: [\n      {\n        role: 'system',\n        content: '## Your Identity\\nYou are the \"WPI ISO Editor,\" a meticulous quality assurance expert specialized in the ISO 17024 standard and technical didactics. Your role is to audit content generated by the Writer and Coder agents to ensure it is \"Exam-Ready\" and free of \"Fluff.\"\\n\\n## Core Audit Criteria\\n\\n### 1. Syllabus & Bloom Compliance\\n- **Coverage:** Verify that every Learning Objective (LO) from the provided Syllabus Domain is addressed\\n- **Bloom Level:** Ensure depth matches target taxonomy (K4 must describe diagnostic paths, not just definitions)\\n- **Fact Check:** Cross-reference technical claims against Source of Truth documents\\n\\n### 2. WPI Tone & Quality Standard\\n- **Neutrality:** Confirm neutral, factual tone\\n- **Address (CRITICAL):** STRICTLY ENFORCE removal of \"Du\" or \"Sie\" in technical instructions. Use passive voice or direct imperatives only.\\n  - DEDUCT -5 pts per Du/Sie violation\\n- **Structure:** Max 5-6 line paragraphs, bold key terms, zero filler words\\n- **Acronyms:** First-Mention Rule - all acronyms must be defined on first use (-2 pts per violation)\\n\\n### 3. Tangibility Mandate\\n- **Code-First:** Every technical topic MUST have syntactically correct code block\\n- **No Placeholders:** No \"// TODO\" or incomplete code\\n- **Calculations:** Show complete calculation paths for metrics\\n\\n## Scoring System (0-100)\\n- LO Completeness: 30 pts (All learning goals covered with Bloom-level depth?)\\n- Clarity & Tone: 25 pts (Zero fluff, correct voice? -5 per Du/Sie, -2 per undefined acronym)\\n- Code Quality: 20 pts (Tangible, commented examples? No placeholders?)\\n- Didactic Structure: 15 pts (Scenario -> Logic -> Takeaways included?)\\n- Exercises: 10 pts (Meaningful Check Your Knowledge + Scenario Drills?)\\n\\n## APPROVAL THRESHOLD\\n- **APPROVED (approved: true):** Score >= 90\\n- **REJECTED (approved: false):** Score < 90 - provide specific required_changes\\n\\n## Output Format (JSON ONLY - no markdown)\\n{\\n  \"score\": number,\\n  \"approved\": boolean,\\n  \"iso_compliant\": boolean,\\n  \"audit_log\": {\\n    \"satisfied_LOs\": [\"K1.1.1\"],\\n    \"missing_LOs\": [],\\n    \"tone_violations\": [],\\n    \"undefined_acronyms\": [],\\n    \"code_blocks_count\": number,\\n    \"code_validation_passed\": boolean\\n  },\\n  \"scoring_breakdown\": {\\n    \"lo_completeness\": number,\\n    \"clarity_and_tone\": number,\\n    \"code_quality\": number,\\n    \"didactic_structure\": number,\\n    \"exercises\": number\\n  },\\n  \"feedback\": {\\n    \"strengths\": [],\\n    \"required_changes\": []\\n  },\\n  \"exam_questions\": [{\\n    \"question\": \"string\",\\n    \"options\": [\"A)\", \"B)\", \"C)\", \"D)\"],\\n    \"correct\": \"char\",\\n    \"bloom_level\": \"string\",\\n    \"learning_objective\": \"string\",\\n    \"explanation\": \"string\"\\n  }]\\n}'\n      },\n      {\n        role: 'user',\n        content: '## AUDIT REQUEST\\n\\n**Chapter ' + (prevData.current_chapter ? prevData.current_chapter.number : '?') + ':** ' + (prevData.current_chapter ? prevData.current_chapter.title : 'Unknown') + '\\n\\n### Target Learning Objectives:\\n' + (prevData.current_chapter && prevData.current_chapter.learning_goals ? prevData.current_chapter.learning_goals.map(function(g, i) { return (i+1) + '. ' + g; }).join('\\n') : 'Not specified') + '\\n\\n### ISO 17024 Compliance Tool Result:\\n' + (isoCompliance ? JSON.stringify(isoCompliance, null, 2) : 'Tool result unavailable - perform manual compliance check') + '\\n\\n### Chapter Content to Audit (MARKDOWN FORMAT):\\n\\n' + draft.substring(0, 12000) + '\\n\\n---\\n**AUDIT INSTRUCTIONS:**\\n1. Check each LO for coverage and Bloom-level depth\\n2. Scan for Du/Sie violations (CRITICAL: -5 pts each)\\n3. Count code blocks, verify no placeholders\\n4. Check structure (intro -> concepts -> practice -> summary)\\n5. Verify exercises are meaningful\\n6. Calculate score using 5 criteria (max 100)\\n7. Generate 5-8 exam questions covering different LOs (IN MARKDOWN FORMAT)\\n8. Return ONLY valid JSON (no markdown code blocks)'\n      }\n    ]\n  });\n})() }}",
        "options": {}
      },
      "id": "4e3f9a72-f829-45be-b1b5-856bd8a961a0",
      "name": "üîç WPI ISO Editor",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -27328,
        11776
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json.choices[0].message.content;\n\n// Get previous data\nlet prevData;\ntry {\n  prevData = $('üîó Merge Code').first().json;\n} catch (e1) {\n  try {\n    prevData = $('‚è≠Ô∏è Skip Code').first().json;\n  } catch (e2) {\n    prevData = $('üìù Extract Code Requests').first().json;\n  }\n}\n\n// Parse WPI ISO Editor response\nlet editorResult;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  editorResult = JSON.parse(jsonStr.trim());\n} catch (e) {\n  editorResult = {\n    score: 0,\n    approved: false,\n    iso_compliant: false,\n    audit_log: { satisfied_LOs: [], missing_LOs: [], tone_violations: [], undefined_acronyms: [], code_blocks_count: 0, code_validation_passed: false },\n    scoring_breakdown: { lo_completeness: 0, clarity_and_tone: 0, code_quality: 0, didactic_structure: 0, exercises: 0 },\n    feedback: { strengths: [], required_changes: ['Failed to parse ISO Editor response: ' + e.message] },\n    exam_questions: []\n  };\n}\n\n// APPROVAL THRESHOLD: >= 90 points\nconst APPROVAL_THRESHOLD = 90;\nconst score = editorResult.score || 0;\nconst isApproved = score >= APPROVAL_THRESHOLD;\neditorResult.approved = isApproved;\n\n// Increment revision count\nconst staticData = $getWorkflowStaticData('global');\nstaticData.revision_count = (staticData.revision_count || 0) + 1;\nconst revision_count = staticData.revision_count;\n\nreturn {\n  json: {\n    ...prevData,\n    editor_score: score,\n    editor_approved: isApproved,\n    approval_threshold: APPROVAL_THRESHOLD,\n    iso_compliant: editorResult.iso_compliant || false,\n    audit_log: editorResult.audit_log || {},\n    scoring_breakdown: editorResult.scoring_breakdown || {},\n    editor_feedback: editorResult.feedback || { strengths: [], required_changes: [] },\n    exam_questions: editorResult.exam_questions || [],\n    revision_count: revision_count\n  }\n};"
      },
      "id": "4cf2e685-2c9d-4cdc-98a9-2b9a87af829d",
      "name": "üìä Parse ISO Editor Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -27104,
        11776
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "approved",
              "leftValue": "={{ $json.editor_approved }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "9d52d63e-bc57-4b43-83ce-e21df008bd42",
      "name": "üîÄ Quality OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -26880,
        11776
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "max-revisions",
              "leftValue": "={{ $json.revision_count }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "1d43d61b-db97-482c-8dbf-c0bf784f4fde",
      "name": "üîÄ Max Revisions?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -26656,
        12136
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-research:3003/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'ingest_and_embed',\n  arguments: {\n    text: $json.draft_content,\n    metadata: {\n      source: 'wpi-content-factory',\n      title: $json.blueprint.title + ' - Kapitel ' + $json.current_chapter.number,\n      document_type: 'book_chapter',\n      domain_id: $json.current_chapter.domain_id || $json.current_chapter.topic_id || null,\n      tags: ['generated', 'book-chapter', $('üîß Initialize BookState').first().json.book_id],\n      language: 'de'\n    },\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "b52f8122-639a-420b-bb51-b9e0162914c6",
      "name": "üíæ MCP: Store in Knowledge Base",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -26656,
        11752
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Mark chapter as stored and output complete chapter data\nlet prevData;\ntry {\n  prevData = $('üìä Parse ISO Editor Result').first().json;\n} catch (e) {\n  prevData = $input.first().json;\n}\n\n// Try to get ingestion result\nlet ingestionResult = null;\ntry {\n  const ingestResp = $('üíæ MCP: Store in Knowledge Base').first().json;\n  if (ingestResp.body?.content?.[0]?.text) {\n    ingestionResult = JSON.parse(ingestResp.body.content[0].text);\n  }\n} catch (e) {\n  console.log('Ingestion result not available:', e.message);\n}\n\nconst chapterNumber = prevData.current_chapter?.number || (prevData.current_chapter_index !== undefined ? prevData.current_chapter_index + 1 : 1);\n\n// Format exam questions as Markdown\nconst examQuestionsMarkdown = (prevData.exam_questions || []).map((q, i) => {\n  return '**Frage ' + (i + 1) + ':** ' + q.question + '\\n\\n' +\n    (q.options || []).join('\\n') + '\\n\\n' +\n    '> **Antwort:** ' + (q.correct || 'N/A') + '\\n> *' + (q.explanation || '') + '*';\n}).join('\\n\\n---\\n\\n');\n\nconsole.log('Finalizing chapter', chapterNumber, 'score:', prevData.editor_score || 0);\n\nreturn {\n  json: {\n    chapter_number: chapterNumber,\n    title: prevData.current_chapter?.title || 'Untitled',\n    content: prevData.draft_content || '',\n    exam_questions: prevData.exam_questions || [],\n    exam_questions_markdown: examQuestionsMarkdown,\n    score: prevData.editor_score || 0,\n    iso_compliant: prevData.iso_compliant || false,\n    approval_threshold: prevData.approval_threshold || 90,\n    passed_quality: prevData.editor_approved || false,\n    stored_in_kb: !!ingestionResult,\n    kb_document_id: ingestionResult?.document_id || null,\n    blueprint: prevData.blueprint,\n    book_id: prevData.book_id,\n    current_chapter_index: prevData.current_chapter_index,\n    target_audience: prevData.target_audience\n  }\n};"
      },
      "id": "134d211d-1d00-4a52-928b-fbf8f27556dd",
      "name": "‚úÖ Finalize Chapter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -26432,
        12136
      ]
    },
    {
      "parameters": {
        "fromEmail": "content-factory@wpi.org",
        "toEmail": "hennadii.shvedko@gmail.com",
        "subject": "=üìñ Kapitel {{ $json.chapter_number }}: {{ $json.title }} (Score: {{ $json.score }}/100)",
        "html": "=<h1>Kapitel {{ $json.chapter_number }} fertiggestellt</h1>\n<p><strong>Titel:</strong> {{ $json.title }}</p>\n<p><strong>Buch:</strong> {{ $json.blueprint.title }}</p>\n<p><strong>Zielgruppe:</strong> {{ $json.target_audience }}</p>\n<p><strong>Quality Score:</strong> {{ $json.score }}/100 {{ $json.passed_quality ? '‚úÖ Approved' : '‚ö†Ô∏è Below threshold' }}</p>\n<p><strong>ISO 17024:</strong> {{ $json.iso_compliant ? '‚úÖ Compliant' : '‚ö†Ô∏è Check required' }}</p>\n<p><strong>In KB gespeichert:</strong> {{ $json.stored_in_kb ? 'Ja' : 'Nein' }}</p>\n\n<hr>\n\n<h2>Kapitel-Inhalt (Markdown)</h2>\n<pre style=\"white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 600px; overflow: auto;\">{{ $json.content }}</pre>\n\n<hr>\n\n<h2>Pr√ºfungsfragen (Markdown)</h2>\n<pre style=\"white-space: pre-wrap; font-family: monospace; background: #f0f8ff; padding: 15px; border-radius: 5px;\">{{ $json.exam_questions_markdown || 'Keine Fragen generiert' }}</pre>",
        "options": {}
      },
      "id": "fbd99b8d-9318-4207-9cb0-69263b60dc04",
      "name": "üìß Send Chapter Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -31360,
        13024
      ],
      "webhookId": "21c5af5b-0d32-4ac3-91f8-57dcf1d4805d",
      "credentials": {
        "smtp": {
          "id": "ZydhFDFy3w045RlS",
          "name": "SMTP account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://mcp-standards:3002/chapters/{{ $('üîß Initialize BookState').first().json.book_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($('‚úÖ Finalize Chapter').first().json) }}",
        "options": {}
      },
      "id": "49225492-3da0-413d-aab2-bd8b6445b5aa",
      "name": "üì¶ Store Chapter",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -31136,
        13024
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "all-chapters-done",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": "={{ $('üìë Prepare Chapters').first().json.total_chapters }}",
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5e49aaf0-14e8-4f31-9c8c-a989a1f163cb",
      "name": "üîÄ All Chapters Done?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -30688,
        12640
      ]
    },
    {
      "parameters": {
        "url": "=http://mcp-standards:3002/chapters/{{ $('üîß Initialize BookState').first().json.book_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "41aedbe1-8894-4273-9913-ecd67eb61b2b",
      "name": "üì• Get Accumulated Chapters",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -30464,
        12640
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Get chapters from the accumulator service\nconsole.log('=== COMPILE BOOK DEBUG ===');\n\nlet finalChapters = [];\nlet book_id = 'unknown';\nlet blueprint = { title: 'Unknown Book', subtitle: '' };\n\ntry {\n  const accumulatorResponse = $('üì• Get Accumulated Chapters').first().json;\n  console.log('Accumulator response chapters:', accumulatorResponse.chapters?.length || 0);\n  \n  if (accumulatorResponse.chapters && Array.isArray(accumulatorResponse.chapters)) {\n    finalChapters = accumulatorResponse.chapters;\n    book_id = accumulatorResponse.book_id || 'unknown';\n  }\n  \n  if (finalChapters.length > 0 && finalChapters[0].blueprint) {\n    blueprint = finalChapters[0].blueprint;\n  }\n} catch (e) {\n  console.log('Could not get chapters from accumulator:', e.message);\n}\n\nconsole.log('Final chapters to compile:', finalChapters.length);\n\nif (finalChapters.length === 0) {\n  return {\n    json: {\n      book_id: book_id,\n      title: 'ERROR: No chapters',\n      error: 'No chapters were accumulated',\n      final_markdown: '# ERROR\\n\\nNo chapters were processed.',\n      exam_questions_markdown: '# Keine Pr√ºfungsfragen\\n\\nKeine Kapitel wurden verarbeitet.',\n      chapter_scores: [],\n      average_score: 0,\n      total_chapters: 0,\n      completed_at: new Date().toISOString()\n    }\n  };\n}\n\n// Sort by chapter number\nfinalChapters.sort((a, b) => (a.chapter_number || 0) - (b.chapter_number || 0));\n\n// Create final book markdown\nlet bookMarkdown = '# ' + blueprint.title + '\\n\\n';\nbookMarkdown += '*' + (blueprint.subtitle || '') + '*\\n\\n';\n\nif (blueprint.iso_alignment) {\n  bookMarkdown += '**ISO 17024 Syllabus:** ' + (blueprint.iso_alignment.syllabus_id || blueprint.iso_alignment.domain_id) + '\\n\\n';\n}\n\nbookMarkdown += '---\\n\\n## Inhaltsverzeichnis\\n\\n';\nfinalChapters.forEach((ch, i) => {\n  bookMarkdown += (i + 1) + '. ' + (ch.title || 'Kapitel ' + (i + 1)) + '\\n';\n});\nbookMarkdown += '\\n---\\n\\n';\n\nfinalChapters.forEach((ch, i) => {\n  const chapterContent = ch.content || '';\n  console.log('Chapter', ch.chapter_number || i + 1, 'content length:', chapterContent.length);\n  if (chapterContent) {\n    bookMarkdown += chapterContent + '\\n\\n---\\n\\n';\n  }\n});\n\n// Collect all exam questions as Markdown\nlet allQuestionsMarkdown = '# Pr√ºfungsfragen\\n\\n';\nfinalChapters.forEach((ch) => {\n  if (ch.exam_questions_markdown) {\n    allQuestionsMarkdown += '## Kapitel ' + ch.chapter_number + ': ' + ch.title + '\\n\\n';\n    allQuestionsMarkdown += ch.exam_questions_markdown + '\\n\\n---\\n\\n';\n  }\n});\n\n// Calculate average score\nconst validScores = finalChapters.filter(ch => typeof ch.score === 'number' && ch.score > 0);\nconst averageScore = validScores.length > 0 \n  ? validScores.reduce((sum, ch) => sum + ch.score, 0) / validScores.length \n  : 0;\n\nconsole.log('Average score:', averageScore);\nconsole.log('=== END DEBUG ===');\n\nreturn {\n  json: {\n    book_id: book_id,\n    title: blueprint.title,\n    iso_alignment: blueprint.iso_alignment,\n    final_markdown: bookMarkdown,\n    exam_questions_markdown: allQuestionsMarkdown,\n    chapter_scores: finalChapters.map(ch => ({ \n      chapter: ch.chapter_number || 0, \n      title: ch.title,\n      score: ch.score || 0,\n      iso_compliant: ch.iso_compliant || false,\n      passed_quality: ch.passed_quality || false\n    })),\n    average_score: averageScore,\n    kb_document_ids: finalChapters.map(ch => ch.kb_document_id).filter(Boolean),\n    total_chapters: finalChapters.length,\n    completed_at: new Date().toISOString()\n  }\n};"
      },
      "id": "773f6533-1adb-43a4-aab0-1fe9f5ebd14c",
      "name": "üìö Compile Book",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -30240,
        12640
      ]
    },
    {
      "parameters": {
        "operation": "toText",
        "sourceProperty": "final_markdown",
        "options": {
          "fileName": "={{ $('üîß Initialize BookState').first().json.book_id }}-book.md"
        }
      },
      "id": "64ffef9c-b0bd-45a2-8774-a69d10bd155c",
      "name": "üìÑ Convert Book MD",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -30016,
        12352
      ]
    },
    {
      "parameters": {
        "operation": "toText",
        "sourceProperty": "exam_questions_markdown",
        "options": {
          "fileName": "={{ $('üîß Initialize BookState').first().json.book_id }}-questions.md"
        }
      },
      "id": "4ac8e35d-53f1-41a1-8c1a-ecd448a1d048",
      "name": "üìÑ Convert Questions MD",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -30016,
        12544
      ]
    },
    {
      "parameters": {
        "mode": "append",
        "numberInputs": 4
      },
      "id": "01672d8c-aa1b-43d1-bfa9-c9ca302d9d8a",
      "name": "üîÄ Merge Files",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -29792,
        12448
      ]
    },
    {
      "parameters": {
        "operation": "compress",
        "outputFormat": "zip",
        "fileName": "={{ $json.title ? $json.title.replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü\\-\\s]/g, '').replace(/\\s+/g, '_') : $json.book_id }}.zip",
        "binaryPropertyOutput": "data"
      },
      "id": "82816667-f7f2-46eb-a396-95cc7d73a7fd",
      "name": "üì¶ ZIP Files",
      "type": "n8n-nodes-base.compression",
      "typeVersion": 1,
      "position": [
        -29568,
        12448
      ],
      "alwaysOutputData": false,
      "retryOnFail": true
    },
    {
      "parameters": {
        "fromEmail": "content-factory@wpi.org",
        "toEmail": "hennadii.shvedko@gmail.com",
        "subject": "=‚úÖ Buch fertig: {{ $('üîó Aggregate Files').first().json.title }} (√ò Score: {{ Math.round($('üîó Aggregate Files').first().json.average_score) }}/100)",
        "html": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n  <h1 style=\"color: #2c3e50;\">üìö Buch fertiggestellt!</h1>\n  <p style=\"font-size: 18px;\"><strong>{{ $('üîó Aggregate Files').first().json.title }}</strong></p>\n  {{ $('üîó Aggregate Files').first().json.iso_alignment ? '<p><strong>ISO 17024 Syllabus:</strong> ' + ($('üîó Aggregate Files').first().json.iso_alignment.syllabus_id || $('üîó Aggregate Files').first().json.iso_alignment.domain_id || '') + '</p>' : '' }}\n  <hr style=\"border: 1px solid #eee;\">\n  <table style=\"width: 100%; border-collapse: collapse; margin: 10px 0;\">\n    <tr>\n      <td style=\"padding: 8px; background: #f8f9fa;\"><strong>Durchschnittlicher Quality Score:</strong></td>\n      <td style=\"padding: 8px; background: #f8f9fa; text-align: right;\"><strong>{{ Math.round($('üîó Aggregate Files').first().json.average_score) }}/100</strong></td>\n    </tr>\n    <tr>\n      <td style=\"padding: 8px;\"><strong>In Knowledge Base gespeichert:</strong></td>\n      <td style=\"padding: 8px; text-align: right;\">{{ $('üîó Aggregate Files').first().json.kb_document_ids ? $('üîó Aggregate Files').first().json.kb_document_ids.length : 0 }} Kapitel</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 8px; background: #f8f9fa;\"><strong>Gesamte Kapitel:</strong></td>\n      <td style=\"padding: 8px; background: #f8f9fa; text-align: right;\">{{ $('üîó Aggregate Files').first().json.total_chapters }}</td>\n    </tr>\n  </table>\n  <h3 style=\"color: #2c3e50; margin-top: 20px;\">Chapter Scores:</h3>\n  <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\n    <tr style=\"background: #2c3e50; color: white;\">\n      <th style=\"padding: 10px; text-align: left;\">Kapitel</th>\n      <th style=\"padding: 10px; text-align: left;\">Titel</th>\n      <th style=\"padding: 10px; text-align: center;\">Score</th>\n      <th style=\"padding: 10px; text-align: center;\">Status</th>\n    </tr>\n    {{ $('üîó Aggregate Files').first().json.chapter_scores ? $('üîó Aggregate Files').first().json.chapter_scores.map(cs => '<tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 8px;\">' + cs.chapter + '</td><td style=\"padding: 8px;\">' + cs.title + '</td><td style=\"padding: 8px; text-align: center;\">' + cs.score + '/100</td><td style=\"padding: 8px; text-align: center;\">' + (cs.passed_quality ? '‚úÖ' : '‚ö†Ô∏è') + '</td></tr>').join('') : '<tr><td colspan=\"4\" style=\"padding: 8px;\">Keine Daten</td></tr>' }}\n  </table>\n  <div style=\"margin-top: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px; border: 1px solid #d0e3ff;\">\n    <strong>üì¶ Das ZIP-Archiv enth√§lt 4 Dateien:</strong>\n    <ul style=\"margin: 10px 0; padding-left: 20px;\">\n      <li>üìò <strong>book.md</strong> - Vollst√§ndiges Buch (Markdown)</li>\n      <li>üìù <strong>questions.md</strong> - Pr√ºfungsfragen (Markdown)</li>\n      <li>üåê <strong>book.html</strong> - Vollst√§ndiges Buch (HTML mit CSS-Styling)</li>\n      <li>üåê <strong>questions.html</strong> - Pr√ºfungsfragen (HTML mit CSS-Styling)</li>\n    </ul>\n  </div>\n  <p style=\"margin-top: 20px; color: #888; font-size: 12px;\">Fertiggestellt: {{ $('üîó Aggregate Files').first().json.completed_at }}</p>\n</div>",
        "options": {
          "attachments": "data"
        }
      },
      "id": "08b25ce1-e2cc-40ab-bf97-bfaa37e42126",
      "name": "üìß Final Book Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -29344,
        12448
      ],
      "webhookId": "14a4cc35-74c1-4472-933a-a3bdeadb2c56",
      "credentials": {
        "smtp": {
          "id": "ZydhFDFy3w045RlS",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "content": "## WPI AI Content Factory - Syllabus Driven (Full)\n\n### ALL AI AGENTS ACTIVE:\n- üèóÔ∏è **Architect Agent**: Creates blueprint from domains\n- ‚úçÔ∏è **WPI Technical Architect (v4.4)**: Generates chapters (MARKDOWN)\n- üíª **WPI Coder Agent**: Generates code\n- üîÑ **WPI Coder Self-Correct**: Fixes validation errors\n- üîç **WPI ISO Editor**: Quality gate (90pts threshold)\n\n### ALL MCPs ACTIVE:\n- **mcp-standards** (3002): Syllabus, ISO, Domains\n- **mcp-research** (3003): RAG / Qdrant\n- **mcp-coder** (3004): Code Validation\n\n### CHANGES FROM ORIGINAL:\n1. ‚úÖ Form Trigger with syllabus dropdown\n2. ‚úÖ NO email approval (direct processing)\n3. ‚úÖ Domains = Chapters (from /syllabus/domains)\n4. ‚úÖ Markdown output (not HTML)\n5. ‚úÖ Per-chapter email with MD content\n6. ‚úÖ Final book email with MD attachments\n\n### Flow:\n1. üì• Form Trigger ‚Üí Shows form immediately on Execute\n2. üìö Fetch domains from MCP\n3. üîß Initialize BookState with form data\n4. üèóÔ∏è Architect enriches domain structure\n5. üîÅ Chapter Loop:\n   - üîç Research + Syllabus LOs\n   - ‚úçÔ∏è Writer (MD) ‚Üí üíª Coder ‚Üí üî¨ Validate\n   - üîç ISO Editor ‚Üí 90pt gate\n   - üìß Chapter email (MD content)\n6. üìö Compile ‚Üí üìß Final email (MD files)",
        "height": 620,
        "width": 400
      },
      "id": "3d3573c4-622c-416e-b96b-d2aaf4c84f5f",
      "name": "üìù Info",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -34064,
        11984
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.3,\n  max_tokens: 16000,\n  messages: [\n    {\n      role: 'system',\n      content: 'You are a Markdown-to-HTML converter for WPI study guides.\\n\\nConvert the provided Markdown to complete HTML with embedded CSS.\\n\\nINCLUDE THIS CSS:\\n<!DOCTYPE html>\\n<html lang=\"de\">\\n<head>\\n    <meta charset=\"UTF-8\">\\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\\n    <title>WPI Study Guide</title>\\n    <style>\\n        body { font-family: \\'Segoe UI\\', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; }\\n        h1, h2, h3 { color: #2c3e50; }\\n        h1 { border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-top: 40px; }\\n        h2 { color: #e67e22; margin-top: 40px; border-bottom: 1px solid #eee; padding-bottom: 5px; }\\n        h3 { border-left: 5px solid #3498db; padding-left: 10px; margin-top: 30px; }\\n        h4 { color: #16a085; margin-top: 25px; }\\n        code { background-color: #f4f4f4; padding: 2px 5px; border-radius: 3px; font-family: Consolas, monospace; color: #c7254e; font-size: 0.9em; }\\n        pre { background-color: #282c34; color: #abb2bf; border: 1px solid #ddd; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: Consolas, monospace; font-size: 0.9em; margin: 20px 0; }\\n        blockquote { border-left: 4px solid #3498db; margin: 20px 0; padding: 10px 20px; background-color: #eaf2f8; font-style: italic; }\\n        table { border-collapse: collapse; width: 100%; margin: 25px 0; font-size: 0.95em; }\\n        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }\\n        th { background-color: #2c3e50; color: white; }\\n        tr:nth-child(even) { background-color: #f2f2f2; }\\n        .scenario { background-color: #fff3e0; padding: 20px; border-left: 5px solid #ff9800; border-radius: 4px; margin: 30px 0; }\\n        .definition { background-color: #f3e5f5; padding: 20px; border-left: 5px solid #9c27b0; border-radius: 4px; margin: 25px 0; }\\n        .best-practice { background-color: #e8f5e9; padding: 20px; border-left: 5px solid #4caf50; border-radius: 4px; margin: 25px 0; }\\n        .pitfall { background-color: #ffebee; padding: 20px; border-left: 5px solid #f44336; border-radius: 4px; margin: 25px 0; }\\n        .ai-copilot { background-color: #e0f7fa; padding: 20px; border-left: 5px solid #00bcd4; border-radius: 4px; margin: 25px 0; border: 1px dashed #0097a7; }\\n        .drill { background-color: #fbe9e7; padding: 25px; border: 1px solid #ffab91; border-radius: 8px; margin-top: 40px; }\\n        ul, ol { margin-bottom: 20px; }\\n        li { margin-bottom: 8px; }\\n    </style>\\n</head>\\n<body>\\n\\nConvert Markdown to HTML and wrap in this template. Output ONLY complete HTML.'\n    },\n    {\n      role: 'user',\n      content: 'Convert this Markdown to styled HTML:\\n\\n' + $json.final_markdown\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "893e6dfb-0732-4fc4-bcce-1367dfa55018",
      "name": "üåê Convert Book to HTML",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -30016,
        12736
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.3,\n  max_tokens: 16000,\n  messages: [\n    {\n      role: 'system',\n      content: 'You are a Markdown-to-HTML converter for WPI study guides.\\n\\nConvert the provided Markdown to complete HTML with embedded CSS.\\n\\nINCLUDE THIS CSS:\\n<!DOCTYPE html>\\n<html lang=\"de\">\\n<head>\\n    <meta charset=\"UTF-8\">\\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\\n    <title>WPI Pr√ºfungsfragen</title>\\n    <style>\\n        body { font-family: \\'Segoe UI\\', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; }\\n        h1, h2, h3 { color: #2c3e50; }\\n        h1 { border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-top: 40px; }\\n        h2 { color: #e67e22; margin-top: 40px; border-bottom: 1px solid #eee; padding-bottom: 5px; }\\n        h3 { border-left: 5px solid #3498db; padding-left: 10px; margin-top: 30px; }\\n        code { background-color: #f4f4f4; padding: 2px 5px; border-radius: 3px; font-family: Consolas, monospace; color: #c7254e; font-size: 0.9em; }\\n        pre { background-color: #282c34; color: #abb2bf; border: 1px solid #ddd; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: Consolas, monospace; font-size: 0.9em; margin: 20px 0; }\\n        blockquote { border-left: 4px solid #3498db; margin: 20px 0; padding: 10px 20px; background-color: #eaf2f8; font-style: italic; }\\n        ul, ol { margin-bottom: 20px; }\\n        li { margin-bottom: 8px; }\\n    </style>\\n</head>\\n<body>\\n\\nConvert Markdown to HTML and wrap in this template. Output ONLY complete HTML.'\n    },\n    {\n      role: 'user',\n      content: 'Convert this Markdown to styled HTML:\\n\\n' + $json.exam_questions_markdown\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "06b2a41f-49fd-4f1b-991d-a325b8f4d28e",
      "name": "üåê Convert Questions to HTML",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -30016,
        12928
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const htmlContent = $input.first().json.choices[0].message.content;\nconst originalData = $('üìö Compile Book').first().json;\n\nreturn {\n  json: {\n    ...originalData,\n    final_html: htmlContent\n  }\n};"
      },
      "id": "14d24cd1-c7e6-4351-ba12-c87a86df4a91",
      "name": "üìã Extract HTML Book",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -29792,
        12736
      ]
    },
    {
      "parameters": {
        "jsCode": "const htmlContent = $input.first().json.choices[0].message.content;\nconst originalData = $('üìö Compile Book').first().json;\n\nreturn {\n  json: {\n    ...originalData,\n    exam_questions_html: htmlContent\n  }\n};"
      },
      "id": "8a399bcd-0624-44e4-9053-15da5ad25e5b",
      "name": "üìã Extract HTML Questions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -29792,
        12928
      ]
    },
    {
      "parameters": {
        "operation": "toText",
        "sourceProperty": "final_html",
        "options": {
          "fileName": "={{ $('üîß Initialize BookState').first().json.book_id }}-book.html"
        }
      },
      "id": "c8e969fe-4f5d-4277-be32-e92245d8958a",
      "name": "üìÑ Convert Book HTML",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -29568,
        12736
      ]
    },
    {
      "parameters": {
        "operation": "toText",
        "sourceProperty": "exam_questions_html",
        "options": {
          "fileName": "={{ $('üîß Initialize BookState').first().json.book_id }}-questions.html"
        }
      },
      "id": "ebab67f6-3016-4986-89dd-c8252048b89a",
      "name": "üìÑ Convert Questions HTML",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -29568,
        12928
      ]
    },
    {
      "parameters": {
        "jsCode": "// Aggregate all 4 files from Merge into 1 item with all binary properties\n// Merge outputs 4 items (1 per file), we combine them into 1\n\nconst items = $input.all();\nconst compileData = $('üìö Compile Book').first().json;\n\n// Combine all binary data from all items into one object\nconst combinedBinary = {};\n\nfor (const item of items) {\n  if (item.binary) {\n    for (const [key, value] of Object.entries(item.binary)) {\n      // Use the file name (without extension) as the key to avoid overwriting\n      const fileName = value.fileName || key;\n      if (fileName.includes('book') && fileName.endsWith('.md')) {\n        combinedBinary['book_md'] = value;\n      } else if (fileName.includes('questions') && fileName.endsWith('.md')) {\n        combinedBinary['questions_md'] = value;\n      } else if (fileName.includes('book') && fileName.endsWith('.html')) {\n        combinedBinary['book_html'] = value;\n      } else if (fileName.includes('questions') && fileName.endsWith('.html')) {\n        combinedBinary['questions_html'] = value;\n      } else {\n        combinedBinary[key] = value;\n      }\n    }\n  }\n}\n\nreturn [{\n  json: {\n    title: compileData.title,\n    book_id: compileData.book_id,\n    average_score: compileData.average_score,\n    total_chapters: compileData.total_chapters,\n    chapter_scores: compileData.chapter_scores,\n    kb_document_ids: compileData.kb_document_ids,\n    iso_alignment: compileData.iso_alignment,\n    completed_at: compileData.completed_at,\n    file_count: Object.keys(combinedBinary).length\n  },\n  binary: combinedBinary\n}];"
      },
      "id": "aggregate-files-code-node",
      "name": "üîó Aggregate Files",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -29568,
        12448
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "üì• Book Request Form": {
      "main": [
        [
          {
            "node": "üîç Extract Syllabus ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Extract Syllabus ID": {
      "main": [
        [
          {
            "node": "üîÑ Activate Syllabus",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ Activate Syllabus": {
      "main": [
        [
          {
            "node": "üîÄ Route by Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Route by Strategy": {
      "main": [
        [
          {
            "node": "üìö Fetch Syllabus Domains",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìë Fetch Syllabus Topics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìö Fetch Syllabus Domains": {
      "main": [
        [
          {
            "node": "üîß Initialize BookState",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìë Fetch Syllabus Topics": {
      "main": [
        [
          {
            "node": "üîß Initialize BookState",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Initialize BookState": {
      "main": [
        [
          {
            "node": "üìö MCP: Get Syllabus Section",
            "type": "main",
            "index": 0
          },
          {
            "node": "üîç MCP: Search Knowledge Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìö MCP: Get Syllabus Section": {
      "main": [
        [
          {
            "node": "üîÄ Merge MCP Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç MCP: Search Knowledge Base": {
      "main": [
        [
          {
            "node": "üîÄ Merge MCP Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Merge MCP Context": {
      "main": [
        [
          {
            "node": "üèóÔ∏è Architect Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üèóÔ∏è Architect Agent": {
      "main": [
        [
          {
            "node": "üìã Parse Blueprint",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Parse Blueprint": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Clear Chapter Accumulator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Clear Chapter Accumulator": {
      "main": [
        [
          {
            "node": "üìë Prepare Chapters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìë Prepare Chapters": {
      "main": [
        [
          {
            "node": "üîÅ Chapter Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÅ Chapter Loop": {
      "main": [
        [
          {
            "node": "üîÄ All Chapters Done?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üîç MCP: Chapter Research",
            "type": "main",
            "index": 0
          },
          {
            "node": "üìö MCP: Get Chapter LOs",
            "type": "main",
            "index": 0
          },
          {
            "node": "üîÄ Add Chapter Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üîç MCP: Chapter Research": {
      "main": [
        [
          {
            "node": "üîÄ Merge MCP Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìö MCP: Get Chapter LOs": {
      "main": [
        [
          {
            "node": "üîÄ Merge MCP Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üîÄ Merge MCP Results": {
      "main": [
        [
          {
            "node": "üîÄ Add Chapter Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Add Chapter Data": {
      "main": [
        [
          {
            "node": "üíæ Merge Chapter Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Merge Chapter Context": {
      "main": [
        [
          {
            "node": "‚úçÔ∏è WPI Technical Architect",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úçÔ∏è WPI Technical Architect": {
      "main": [
        [
          {
            "node": "üìù Extract Code Requests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Extract Code Requests": {
      "main": [
        [
          {
            "node": "üîÄ Code Needed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Code Needed?": {
      "main": [
        [
          {
            "node": "üíª WPI Coder Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚è≠Ô∏è Skip Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíª WPI Coder Agent": {
      "main": [
        [
          {
            "node": "üîó Merge Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîó Merge Code": {
      "main": [
        [
          {
            "node": "üî¨ MCP: Validate Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üî¨ MCP: Validate Code": {
      "main": [
        [
          {
            "node": "üìä Parse Code Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Parse Code Validation": {
      "main": [
        [
          {
            "node": "üîÄ Code Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Code Valid?": {
      "main": [
        [
          {
            "node": "üìã MCP: ISO Compliance Check",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üîÄ Code Retry?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Code Retry?": {
      "main": [
        [
          {
            "node": "üîÑ WPI Coder Self-Correct",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚è≠Ô∏è Skip Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ WPI Coder Self-Correct": {
      "main": [
        [
          {
            "node": "üîó Merge Corrected Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîó Merge Corrected Code": {
      "main": [
        [
          {
            "node": "üî¨ MCP: Validate Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚è≠Ô∏è Skip Validation": {
      "main": [
        [
          {
            "node": "üìã MCP: ISO Compliance Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚è≠Ô∏è Skip Code": {
      "main": [
        [
          {
            "node": "üìã MCP: ISO Compliance Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã MCP: ISO Compliance Check": {
      "main": [
        [
          {
            "node": "üîç WPI ISO Editor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç WPI ISO Editor": {
      "main": [
        [
          {
            "node": "üìä Parse ISO Editor Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Parse ISO Editor Result": {
      "main": [
        [
          {
            "node": "üîÄ Quality OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Quality OK?": {
      "main": [
        [
          {
            "node": "üíæ MCP: Store in Knowledge Base",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üîÄ Max Revisions?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ MCP: Store in Knowledge Base": {
      "main": [
        [
          {
            "node": "‚úÖ Finalize Chapter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Finalize Chapter": {
      "main": [
        [
          {
            "node": "üì¶ Store Chapter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìß Send Chapter Email": {
      "main": [
        [
          {
            "node": "üì¶ Store Chapter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì¶ Store Chapter": {
      "main": [
        [
          {
            "node": "üîÅ Chapter Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ All Chapters Done?": {
      "main": [
        [
          {
            "node": "üì• Get Accumulated Chapters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì• Get Accumulated Chapters": {
      "main": [
        [
          {
            "node": "üìö Compile Book",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Max Revisions?": {
      "main": [
        [
          {
            "node": "‚úçÔ∏è WPI Technical Architect",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚úÖ Finalize Chapter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìö Compile Book": {
      "main": [
        [
          {
            "node": "üìÑ Convert Book MD",
            "type": "main",
            "index": 0
          },
          {
            "node": "üìÑ Convert Questions MD",
            "type": "main",
            "index": 0
          },
          {
            "node": "üåê Convert Book to HTML",
            "type": "main",
            "index": 0
          },
          {
            "node": "üåê Convert Questions to HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Convert Book MD": {
      "main": [
        [
          {
            "node": "üîÄ Merge Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Convert Questions MD": {
      "main": [
        [
          {
            "node": "üîÄ Merge Files",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üì¶ ZIP Files": {
      "main": [
        [
          {
            "node": "üìß Final Book Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üåê Convert Book to HTML": {
      "main": [
        [
          {
            "node": "üìã Extract HTML Book",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üåê Convert Questions to HTML": {
      "main": [
        [
          {
            "node": "üìã Extract HTML Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Extract HTML Book": {
      "main": [
        [
          {
            "node": "üìÑ Convert Book HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Extract HTML Questions": {
      "main": [
        [
          {
            "node": "üìÑ Convert Questions HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Convert Book HTML": {
      "main": [
        [
          {
            "node": "üîÄ Merge Files",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "üìÑ Convert Questions HTML": {
      "main": [
        [
          {
            "node": "üîÄ Merge Files",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "üîÄ Merge Files": {
      "main": [
        [
          {
            "node": "üîó Aggregate Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîó Aggregate Files": {
      "main": [
        [
          {
            "node": "üì¶ ZIP Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "680e7949-6099-4e6c-a7f9-23bdaa40018f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "60d48302a9aa1e8edca02aea5b256f3d430c6966fd15714072dd79eb1d923da5"
  },
  "id": "2x3ju9qC1rZQuHsK",
  "tags": [
    {
      "updatedAt": "2026-01-22T08:19:48.642Z",
      "createdAt": "2026-01-22T08:19:48.642Z",
      "id": "5yx7Odspidz9tjQG",
      "name": "WPI"
    },
    {
      "updatedAt": "2026-01-22T08:19:48.690Z",
      "createdAt": "2026-01-22T08:19:48.690Z",
      "id": "BQWMJByq9Vm6jASn",
      "name": "AI"
    },
    {
      "updatedAt": "2026-01-24T15:09:35.714Z",
      "createdAt": "2026-01-24T15:09:35.714Z",
      "id": "Um67A3Nb7UvVyHn0",
      "name": "Syllabus-Driven"
    },
    {
      "updatedAt": "2026-01-22T08:19:48.652Z",
      "createdAt": "2026-01-22T08:19:48.652Z",
      "id": "Zua73lWs0ELXRGMn",
      "name": "MCP-Integrated"
    },
    {
      "updatedAt": "2026-01-22T08:19:48.698Z",
      "createdAt": "2026-01-22T08:19:48.698Z",
      "id": "iRYgw0Jsz0tN1eFX",
      "name": "Content Factory"
    },
    {
      "updatedAt": "2026-01-22T08:19:48.705Z",
      "createdAt": "2026-01-22T08:19:48.705Z",
      "id": "ibzcD43GZdRC88fk",
      "name": "PoC"
    }
  ]
}