{
  "name": "WF-1 Blueprint Generator",
  "nodes": [
    {
      "parameters": {},
      "id": "b947a82d-ebb7-451c-b973-c386a1358309",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Validate input from WF-0 Manager\nconst input = $input.first().json;\n\nconst required = ['job_id', 'syllabus_id', 'target_audience'];\nconst missing = required.filter(f => !input[f]);\n\nif (missing.length > 0) {\n  throw new Error('WF-1 input validation failed. Missing: ' + missing.join(', '));\n}\n\nreturn [{\n  json: {\n    job_id: input.job_id,\n    syllabus_id: input.syllabus_id,\n    syllabus_name: input.syllabus_name || '',\n    generation_strategy: input.generation_strategy || 'By Domain',\n    target_audience: input.target_audience\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "58b649e1-d505-47cb-9309-31ab1da2f8ec",
      "name": "âœ… Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://mcp-standards:3002/syllabuses/{{ $json.syllabus_id }}/activate",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "4fc2bc30-ca3b-4565-a225-3be4d1883995",
      "name": "ğŸ”„ Activate Syllabus",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        500,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "notes": "Activates the selected syllabus in mcp-standards for MCP tools to use"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "15818649-2db7-4a0a-b4c5-a0d88259c5bc",
              "leftValue": "={{ $('âœ… Validate Input').first().json.generation_strategy }}",
              "rightValue": "By Domain",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5492de4a-3643-4503-ad0a-c934b713b651",
      "name": "ğŸ”€ Route by Strategy",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        750,
        300
      ]
    },
    {
      "parameters": {
        "url": "http://mcp-standards:3002/syllabus/domains",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "bc663148-ccf2-43c6-b090-347aae2143a7",
      "name": "ğŸ“š Fetch Syllabus Domains",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1000,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "http://mcp-standards:3002/syllabus/topics",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "60539c21-be83-4d0e-be9b-a271f34916b4",
      "name": "ğŸ“‘ Fetch Syllabus Topics",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1000,
        400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build BookState from validated input + syllabus data\nconst validated = $('âœ… Validate Input').first().json;\nconst data = $input.first().json;\n\nconst isDomainMode = validated.generation_strategy === 'By Domain';\n\nreturn [{\n  json: {\n    book_id: 'book-' + validated.syllabus_id + '-' + Date.now(),\n    job_id: validated.job_id,\n    syllabus_id: validated.syllabus_id,\n    syllabus_name: data.syllabus_name || validated.syllabus_name || 'Unknown Syllabus',\n    generation_strategy: validated.generation_strategy,\n    target_audience: validated.target_audience,\n    total_items: isDomainMode ? (data.total_chapters || 0) : (data.total_topics || 0),\n    items: isDomainMode ? (data.chapters || []) : (data.topics || []),\n    status: 'initialized',\n    created_at: new Date().toISOString()\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "e805f38d-2e96-44c8-9c77-350f44e48e63",
      "name": "ğŸ”§ Initialize BookState",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-standards:3002/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"name\": \"get_syllabus_section\",\n  \"arguments\": {\n    \"domain_id\": \"{{ $json.items[0]?.domain_id || $json.items[0]?.topic_id || 'D1' }}\",\n    \"output_format\": \"json\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "b0014016-e1a4-435d-bf4b-f6d86bedcd0a",
      "name": "ğŸ“š MCP: Get Syllabus Section",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1500,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-research:3003/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"name\": \"hybrid_search\",\n  \"arguments\": {\n    \"query\": \"{{ $('ğŸ”§ Initialize BookState').first().json.syllabus_name + ' ' + ($('ğŸ”§ Initialize BookState').first().json.items || []).map(function(c) { return c.title; }).join(' ') }}\",\n    \"limit\": 10,\n    \"output_format\": \"json\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "08ddce4e-4b49-400e-b623-5c680f248615",
      "name": "ğŸ” MCP: Search Knowledge Base",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1500,
        400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "append",
        "numberInputs": 2
      },
      "id": "7f1491ca-c76a-4298-9961-3b79c9084787",
      "name": "ğŸ”€ Merge MCP Context",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1750,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Combine syllabus and research context\nconst bookState = $('ğŸ”§ Initialize BookState').first().json;\n\n// Get syllabus section (from MCP-Standards)\nlet syllabusContext = null;\ntry {\n  const syllabusResponse = $('ğŸ“š MCP: Get Syllabus Section').first().json;\n  if (syllabusResponse.body && !syllabusResponse.body.error) {\n    const content = syllabusResponse.body.content?.[0]?.text;\n    syllabusContext = content ? JSON.parse(content) : null;\n  }\n} catch (e) {\n  // Syllabus fetch failed, continuing without\n}\n\n// Get research context (from MCP-Research / Qdrant)\nlet researchContext = [];\ntry {\n  const researchResponse = $('ğŸ” MCP: Search Knowledge Base').first().json;\n  if (researchResponse.body && !researchResponse.body.error) {\n    const content = researchResponse.body.content?.[0]?.text;\n    const parsed = content ? JSON.parse(content) : null;\n    researchContext = parsed?.results || [];\n  }\n} catch (e) {\n  // Research fetch failed, continuing without\n}\n\nreturn [{\n  json: {\n    ...bookState,\n    syllabus_context: syllabusContext,\n    research_context: researchContext,\n    has_syllabus: !!syllabusContext,\n    has_research: researchContext.length > 0\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "bc9fdb4f-f8e4-4746-ac59-05595801e843",
      "name": "ğŸ§© Combine MCP Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.3,\n  max_tokens: 4000,\n  messages: [\n    {\n      role: 'system',\n      content: \"Du bist \\\"The Architect\\\" - ein erfahrener Didaktik-Experte fÃ¼r technische FachbÃ¼cher.\\n\\nDeine Aufgabe:\\n1. Analysiere die Syllabus-Struktur (Kapitel/Topics sind bereits vordefiniert!)\\n2. Nutze den Kontext aus der Knowledge Base\\n3. Erstelle detaillierte Lernziele (Learning Objectives) pro Kapitel\\n4. Definiere klare, messbare Lernziele (ISO 17024 konform, Bloom K1-K6)\\n\\nWICHTIG: Die Kapitelstruktur ist bereits vorgegeben!\\nDu sollst NUR die Details ausarbeiten, nicht die Struktur Ã¤ndern.\\n\\nRegeln:\\n- Jedes Kapitel sollte 10-15 Seiten umfassen\\n- Beginne mit Grundlagen, steigere die KomplexitÃ¤t\\n- Jedes Kapitel endet mit einer praktischen Ãœbung\\n- BerÃ¼cksichtige die Zielgruppe bei der Tiefe\\n- Lernziele mÃ¼ssen messbar und Ã¼berprÃ¼fbar sein\\n- Jedes Lernziel braucht eine eindeutige ID und Bloom-Level\\n- KEINE Styling- oder Formatierungsanweisungen â€” nur Inhalt und Struktur\\n\\nOutput-Format: JSON\\n```json\\n{\\n  \\\"title\\\": \\\"Buchtitel (aus Syllabus-Name)\\\",\\n  \\\"subtitle\\\": \\\"Untertitel\\\",\\n  \\\"iso_alignment\\\": {\\n    \\\"syllabus_id\\\": \\\"ID\\\",\\n    \\\"covered_domains\\\": [\\\"D1\\\", \\\"D2\\\"]\\n  },\\n  \\\"chapters\\\": [\\n    {\\n      \\\"number\\\": 1,\\n      \\\"domain_id\\\": \\\"D1\\\",\\n      \\\"title\\\": \\\"Titel\\\",\\n      \\\"learning_objectives\\\": [\\n        { \\\"id\\\": \\\"LO-1.1.1\\\", \\\"description\\\": \\\"Understand X\\\", \\\"bloom_level\\\": \\\"K2\\\" },\\n        { \\\"id\\\": \\\"LO-1.1.2\\\", \\\"description\\\": \\\"Apply Y\\\", \\\"bloom_level\\\": \\\"K3\\\" }\\n      ],\\n      \\\"sections\\\": [\\\"Section 1\\\", \\\"Section 2\\\"],\\n      \\\"estimated_pages\\\": 12,\\n      \\\"practical_exercise\\\": \\\"Beschreibung der Ãœbung\\\"\\n    }\\n  ]\\n}\\n```\\n\\nKRITISCH: Jedes Kapitel MUSS ein \\\"learning_objectives\\\" Array haben mit Objekten die \\\"id\\\", \\\"description\\\" und \\\"bloom_level\\\" enthalten.\"\n    },\n    {\n      role: 'user',\n      content: (function() {\n  const items = $json.items || $json.chapters || [];\n  const totalItems = $json.total_items || $json.total_chapters || items.length;\n  const strategy = $json.generation_strategy || 'By Domain';\n\n  let itemsDescription = items.map(function(item, index) {\n    if (item.chapter_number || item.domain_id) {\n      return 'Kapitel ' + (item.chapter_number || (index + 1)) + ': ' + item.title +\n        '\\n  - Domain ID: ' + (item.domain_id || 'D' + (index + 1)) +\n        '\\n  - Beschreibung: ' + (item.description || 'N/A') +\n        '\\n  - Topics: ' + (item.topics || []).map(function(t) { return t.title; }).join(', ') +\n        '\\n  - Vorhandene Learning Objectives: ' + (item.learning_objectives || []).length + ' StÃ¼ck';\n    } else {\n      return 'Topic ' + item.topic_number + ': ' + item.title +\n        '\\n  - Topic ID: ' + item.topic_id +\n        '\\n  - Domain: ' + item.domain_name + ' (' + item.domain_id + ')' +\n        '\\n  - Learning Objectives: ' + (item.learning_objectives || []).length + ' StÃ¼ck' +\n        (item.subtopics && item.subtopics.length > 0 ? '\\n  - Subtopics: ' + item.subtopics.length + ' StÃ¼ck' : '');\n    }\n  }).join('\\n\\n');\n\n  return 'Erstelle das Inhaltsverzeichnis basierend auf der vorgegebenen Syllabus-Struktur:\\n\\n' +\n    '**Syllabus:** ' + $json.syllabus_name + ' (ID: ' + $json.syllabus_id + ')\\n' +\n    '**Zielgruppe:** ' + $json.target_audience + '\\n' +\n    '**Generierungsstrategie:** ' + strategy + '\\n' +\n    '**Anzahl Items:** ' + totalItems + '\\n\\n' +\n    '**VORDEFINIERTE STRUKTUR:**\\n' + itemsDescription + '\\n\\n' +\n    ($json.has_syllabus ? '**Syllabus-Kontext:**\\n' + JSON.stringify($json.syllabus_context, null, 2) : '') + '\\n\\n' +\n    ($json.has_research ? '**Relevanter Kontext aus Knowledge Base:**\\n' + $json.research_context.slice(0, 5).map(function(r) { return '- ' + (r.text || '').substring(0, 200) + '...'; }).join('\\n') : '') +\n    '\\n\\nWICHTIG: Behalte die Struktur bei! FÃ¼ge Lernziele (learning_objectives), Sections und Ãœbungen hinzu.\\n' +\n    'Jedes Kapitel MUSS ein learning_objectives Array haben mit Objekten: { id, description, bloom_level }.\\n\\n' +\n    'Antworte NUR mit dem JSON, keine ErklÃ¤rungen.';\n})()\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "e562213a-fa3d-4a01-b1fe-b363ff3ea8f3",
      "name": "ğŸ—ï¸ Architect Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2250,
        300
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse the AI response and extract JSON\nconst response = $input.first().json.choices[0].message.content;\n\n// Try to extract JSON from the response\nlet blueprint;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  blueprint = JSON.parse(jsonStr.trim());\n} catch (e) {\n  throw new Error('Failed to parse blueprint JSON: ' + e.message);\n}\n\n// Get the previous state\nconst bookState = $('ğŸ§© Combine MCP Data').first().json;\nconst originalItems = bookState.items || [];\n\n// Merge blueprint chapters with original data\n// CRITICAL: Ensure every chapter has learning_objectives array\nconst mergedChapters = blueprint.chapters.map((bpCh, index) => {\n  const originalItem = originalItems[index] || {};\n\n  // Normalize learning_objectives â€” ensure array of { id, description }\n  let los = bpCh.learning_objectives || bpCh.learning_goals || [];\n  if (typeof los[0] === 'string') {\n    // Convert string LOs to objects\n    los = los.map((desc, i) => ({\n      id: 'LO-' + (bpCh.number || index + 1) + '.' + (i + 1),\n      description: desc,\n      bloom_level: 'K2'\n    }));\n  } else {\n    // Ensure each LO has id and description\n    los = los.map((lo, i) => ({\n      id: lo.id || 'LO-' + (bpCh.number || index + 1) + '.' + (i + 1),\n      description: lo.description || lo.text || String(lo),\n      bloom_level: lo.bloom_level || lo.bloom || 'K2'\n    }));\n  }\n\n  // If no LOs from AI, use original syllabus LOs\n  if (los.length === 0 && originalItem.learning_objectives) {\n    los = originalItem.learning_objectives.map((lo, i) => ({\n      id: lo.id || lo.lo_id || 'LO-' + (index + 1) + '.' + (i + 1),\n      description: lo.description || lo.title || String(lo),\n      bloom_level: lo.bloom_level || lo.bloom || 'K2'\n    }));\n  }\n\n  return {\n    id: bpCh.id || originalItem.domain_id || 'ch-' + (index + 1),\n    number: bpCh.number || index + 1,\n    domain_id: originalItem.domain_id || bpCh.domain_id || 'D' + (index + 1),\n    title: bpCh.title || originalItem.title || 'Chapter ' + (index + 1),\n    learning_objectives: los,\n    sections: bpCh.sections || [],\n    estimated_pages: bpCh.estimated_pages || 12,\n    practical_exercise: bpCh.practical_exercise || '',\n    topic_id: originalItem.topic_id,\n    topic_number: originalItem.topic_number,\n    original_learning_objectives: originalItem.learning_objectives || [],\n    topics: originalItem.topics || bpCh.topics || [],\n    subtopics: originalItem.subtopics || [],\n    weight: originalItem.weight,\n    prerequisites: originalItem.prerequisites || []\n  };\n});\n\nblueprint.chapters = mergedChapters;\n\nreturn [{\n  json: {\n    status: 'success',\n    blueprint: blueprint,\n    job_id: bookState.job_id,\n    syllabus_id: bookState.syllabus_id,\n    total_chapters: mergedChapters.length\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "e4a49be0-012a-47cd-9aab-8426a3a34aaf",
      "name": "ğŸ“‹ Parse Blueprint",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2500,
        300
      ]
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "âœ… Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Validate Input": {
      "main": [
        [
          {
            "node": "ğŸ”„ Activate Syllabus",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Activate Syllabus": {
      "main": [
        [
          {
            "node": "ğŸ”€ Route by Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Route by Strategy": {
      "main": [
        [
          {
            "node": "ğŸ“š Fetch Syllabus Domains",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“‘ Fetch Syllabus Topics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“š Fetch Syllabus Domains": {
      "main": [
        [
          {
            "node": "ğŸ”§ Initialize BookState",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‘ Fetch Syllabus Topics": {
      "main": [
        [
          {
            "node": "ğŸ”§ Initialize BookState",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Initialize BookState": {
      "main": [
        [
          {
            "node": "ğŸ“š MCP: Get Syllabus Section",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ” MCP: Search Knowledge Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“š MCP: Get Syllabus Section": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge MCP Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” MCP: Search Knowledge Base": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge MCP Context",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ”€ Merge MCP Context": {
      "main": [
        [
          {
            "node": "ğŸ§© Combine MCP Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§© Combine MCP Data": {
      "main": [
        [
          {
            "node": "ğŸ—ï¸ Architect Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—ï¸ Architect Agent": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Parse Blueprint",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  }
}