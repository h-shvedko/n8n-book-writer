{
  "name": "WF-4 Code Generation",
  "nodes": [
    {
      "parameters": {
        "mode": "anyInput"
      },
      "id": "6e00015f-0876-41bd-8b0d-e07c5dc2344d",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Validate input from WF-0 Manager\nconst input = $input.first().json;\n\nconst required = ['job_id', 'chapter_id'];\nconst missing = required.filter(f => !input[f]);\n\nif (missing.length > 0) {\n  throw new Error('WF-4 input validation failed. Missing: ' + missing.join(', '));\n}\n\nconst codeRequests = input.code_requests || [];\n\nreturn [{\n  json: {\n    job_id: input.job_id,\n    chapter_id: input.chapter_id,\n    chapter_title: input.chapter_title || input.title || 'Untitled',\n    domain_id: input.domain_id || '',\n    target_audience: input.target_audience || 'Mid-Level Professionals',\n    code_requests: codeRequests,\n    has_code_requests: codeRequests.length > 0\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "c3124067-3a72-449b-bc52-f0a69dee7591",
      "name": "âœ… Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Convert code_requests array into items for SplitInBatches\nconst staticData = $getWorkflowStaticData('global');\nstaticData.code_snippets = [];\n\nconst data = $input.first().json;\nconst requests = data.code_requests || [];\n\nif (requests.length === 0) {\n  // No code requests â€” return empty result directly\n  return [{\n    json: {\n      _skip: true,\n      job_id: data.job_id,\n      chapter_id: data.chapter_id\n    }\n  }];\n}\n\nreturn requests.map((req, index) => ({\n  json: {\n    request_id: 'req_' + (index + 1),\n    description: typeof req === 'string' ? req : (req.description || String(req)),\n    placeholder: typeof req === 'object' ? (req.placeholder || '') : '',\n    index: index,\n    chapter_title: data.chapter_title,\n    domain_id: data.domain_id,\n    target_audience: data.target_audience,\n    job_id: data.job_id,\n    chapter_id: data.chapter_id\n  }\n}));",
        "mode": "runOnceForAllItems"
      },
      "id": "49fbdc07-6aa2-42b6-8a5d-85ac5e7efff7",
      "name": "ğŸ“ Prepare Code Items",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "6d733e22-4724-4e21-9ef7-ce5ac48cc072",
      "name": "ğŸ” Code Request Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        750,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Reset retry counter for this code request\nconst staticData = $getWorkflowStaticData('global');\nstaticData.current_retry = 0;\n\nconst req = $input.first().json;\nreturn [{ json: req }];",
        "mode": "runOnceForAllItems"
      },
      "id": "9a75c9a7-84f4-4bee-bfe7-0b805b49d62f",
      "name": "ğŸ“ Init Request Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        500
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.2,\n  max_tokens: 4000,\n  messages: [\n    {\n      role: 'system',\n      content: '## Your Identity\\nYou are the \"WPI Coder Agent,\" a Senior Full-Stack Engineer and technical author. Your goal is to generate high-quality, production-ready code examples for the WPI Syllabus Guide.\\n\\n## Core Responsibilities\\n1. **Follow the Tangibility Mandate:** For every technical topic, you MUST provide a complete, syntactically correct code block.\\n2. **Technical Standards:** Use modern syntax (ES6+ for JavaScript, HTML5, CSS3) and handle common edge cases.\\n3. **WPI Tone of Voice:** Use a \"Professional-Instructive\" voice. Avoid \"Du\" or \"Sie\" in technical instructions.\\n4. **Zero Fluff:** Provide maximum competence with no filler words.\\n\\n## Code Validation Requirements\\nYour code will be automatically validated by the MCP Coder service after generation:\\n- JavaScript/TypeScript: ESLint ES6+ strict validation\\n- HTML: Structure and accessibility validation\\n- CSS: Syntax validation\\n\\n## Best Practices\\n1. Use const/let, never var\\n2. Use arrow functions and template literals\\n3. Handle errors gracefully\\n4. Include edge case handling\\n5. Add meaningful comments (German)\\n6. Keep examples practical and production-ready\\n\\n## Output Format\\nReturn ONLY a JSON object:\\n{\\n  \"language\": \"javascript\",\\n  \"code\": \"// VollstÃ¤ndiger, lauffÃ¤higer Code hier\",\\n  \"explanation\": \"Kurze ErklÃ¤rung wie es funktioniert.\",\\n  \"impact\": \"Warum ist dieser Ansatz wichtig?\"\\n}\\n\\nWICHTIG: Antworte NUR mit validem JSON. Keine Markdown-BlÃ¶cke, keine ErklÃ¤rungen auÃŸerhalb des JSON.'\n    },\n    {\n      role: 'user',\n      content: 'Erstelle ein Code-Beispiel fÃ¼r folgende Anfrage:\\n\\n**Anfrage:** ' + $json.description + '\\n\\n**Kontext:** Kapitel \"' + $json.chapter_title + '\"\\n**Zielgruppe:** ' + $json.target_audience + '\\n\\n**WICHTIG:** Der Code wird automatisch validiert. Achte besonders auf:\\n- ES6+ Syntax (const/let, arrow functions, template literals)\\n- Keine ungenutzten Variablen\\n- Syntaktische Korrektheit\\n- Edge Case Handling\\n\\nAntworte NUR mit dem JSON-Objekt.'\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "a59ae8fe-bf2d-4613-99ff-84770ab8d6dd",
      "name": "ğŸ’» WPI Coder Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1250,
        500
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse the AI-generated code from response\nconst reqData = $('ğŸ“ Init Request Context').first().json;\nconst response = $input.first().json.choices[0].message?.content || '';\n\nlet codeResult;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  codeResult = JSON.parse(jsonStr.trim());\n} catch (e) {\n  // Fallback: extract code block from markdown\n  const codeMatch = response.match(/```(\\w*)\\n([\\s\\S]*?)```/);\n  if (codeMatch) {\n    codeResult = {\n      language: codeMatch[1] || 'javascript',\n      code: codeMatch[2].trim(),\n      explanation: '',\n      impact: ''\n    };\n  } else {\n    // Last resort: treat entire response as code\n    codeResult = {\n      language: 'javascript',\n      code: response.trim(),\n      explanation: '',\n      impact: ''\n    };\n  }\n}\n\nreturn [{\n  json: {\n    request_id: reqData.request_id,\n    description: reqData.description,\n    placeholder: reqData.placeholder,\n    language: codeResult.language || 'javascript',\n    code: codeResult.code || '',\n    explanation: codeResult.explanation || '',\n    impact: codeResult.impact || '',\n    raw_response: response,\n    job_id: reqData.job_id,\n    chapter_id: reqData.chapter_id\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "859c2a0f-c54e-496c-acc2-56e657124c32",
      "name": "ğŸ”— Parse Code Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        500
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-coder:3004/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ (function() {\n  const code = $json.code || '// no code';\n  const lang = $json.language || 'javascript';\n  const langMap = { 'js': 'javascript', 'ts': 'typescript', 'jsx': 'javascript', 'tsx': 'typescript' };\n  const normalizedLang = langMap[lang] || lang;\n  const validLangs = ['javascript', 'typescript', 'html', 'css', 'json'];\n  return JSON.stringify({\n    name: 'validate_code_snippet',\n    arguments: {\n      code: code,\n      language: validLangs.includes(normalizedLang) ? normalizedLang : 'javascript',\n      strict_mode: true,\n      check_best_practices: false\n    }\n  });\n})() }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "5610a20c-b805-43ee-a0c4-3a092ec20bd5",
      "name": "ğŸ”¬ MCP: Validate Code",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1750,
        500
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Parse validation result from MCP-Coder\nconst codeData = $('ğŸ”— Parse Code Response').first().json;\nconst staticData = $getWorkflowStaticData('global');\n\nlet validationResult = { valid: true, errors: [], suggestions: [] };\ntry {\n  const valResp = $input.first().json;\n  if (valResp.body?.content?.[0]?.text) {\n    validationResult = JSON.parse(valResp.body.content[0].text);\n  }\n} catch (e) {\n  // Validation service unavailable â€” treat as valid\n}\n\nreturn [{\n  json: {\n    ...codeData,\n    code_validated: !!validationResult.valid,\n    code_errors: validationResult.errors || [],\n    code_suggestions: validationResult.suggestions || [],\n    retry_count: staticData.current_retry || 0\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "5a7e1b1d-880b-4054-be92-f2c32170bfa0",
      "name": "ğŸ“Š Parse Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "code-valid",
              "leftValue": "={{ $json.code_validated }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9269cc37-f0bf-44f7-992f-6dbcb083c4e9",
      "name": "ğŸ”€ Code Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2250,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "// Store validated code snippet in static data\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.code_snippets) staticData.code_snippets = [];\n\nconst data = $input.first().json;\n\nstaticData.code_snippets.push({\n  id: data.request_id,\n  description: data.description,\n  placeholder: data.placeholder,\n  code: data.code,\n  language: data.language,\n  explanation: data.explanation || '',\n  impact: data.impact || '',\n  validated: true,\n  retries: data.retry_count || 0\n});\n\nreturn [{ json: { collected: true, request_id: data.request_id, validated: true } }];",
        "mode": "runOnceForAllItems"
      },
      "id": "f2ce31d8-01c9-472e-ad09-0086ae6790f9",
      "name": "ğŸ“¦ Collect Valid Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2500,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "retry-limit",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "49fcd696-a587-4cee-a66e-ee22d76aca12",
      "name": "ğŸ”€ Retry Limit?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2500,
        600
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: 'gpt-4o',\n  temperature: 0.1,\n  max_tokens: 4000,\n  messages: [\n    {\n      role: 'system',\n      content: '## Your Identity\\nYou are the \"WPI Coder Agent\" performing SELF-CORRECTION based on validation errors.\\n\\n## Your Task\\nThe code you previously generated failed validation. You MUST fix ALL errors reported by the validator.\\n\\n## Correction Strategy\\n1. Fix syntax errors first (blocking issues)\\n2. Apply ES6+ best practices (const/let, arrow functions, template literals)\\n3. Remove unused variables\\n4. Ensure all edge cases are handled\\n5. Maintain code readability and comments\\n\\n## Output Format\\nReturn ONLY a JSON object with the corrected code:\\n{\\n  \"language\": \"javascript\",\\n  \"code\": \"// Korrigierter, lauffÃ¤higer Code\",\\n  \"explanation\": \"Kurze ErklÃ¤rung\",\\n  \"impact\": \"Warum dieser Ansatz\"\\n}\\n\\nWICHTIG: Antworte NUR mit validem JSON. Keine ErklÃ¤rungen auÃŸerhalb des JSON.'\n    },\n    {\n      role: 'user',\n      content: '**Validation Failed - Self-Correction Required**\\n\\n**Original Code (' + $json.language + '):**\\n' + $json.code + '\\n\\n**Validation Errors:**\\n' + JSON.stringify($json.code_errors, null, 2) + '\\n\\n**Suggestions:**\\n' + ($json.code_suggestions || []).join('\\n') + '\\n\\n**Retry:** ' + (($json.retry_count || 0) + 1) + ' / 3\\n\\nFix ALL errors and return the corrected code as JSON.'\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "0ff65241-0aa5-4738-8b0b-32a2b35f5004",
      "name": "ğŸ”„ WPI Coder Self-Correct",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2750,
        500
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse self-corrected code and increment retry counter\nconst staticData = $getWorkflowStaticData('global');\nstaticData.current_retry = (staticData.current_retry || 0) + 1;\n\nconst prevData = $('ğŸ“Š Parse Validation').first().json;\nconst response = $input.first().json.choices[0].message?.content || '';\n\nlet codeResult;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  codeResult = JSON.parse(jsonStr.trim());\n} catch (e) {\n  const codeMatch = response.match(/```(\\w*)\\n([\\s\\S]*?)```/);\n  if (codeMatch) {\n    codeResult = {\n      language: codeMatch[1] || prevData.language,\n      code: codeMatch[2].trim()\n    };\n  } else {\n    codeResult = {\n      language: prevData.language,\n      code: response.trim()\n    };\n  }\n}\n\nreturn [{\n  json: {\n    request_id: prevData.request_id,\n    description: prevData.description,\n    placeholder: prevData.placeholder,\n    language: codeResult.language || prevData.language,\n    code: codeResult.code || prevData.code,\n    explanation: codeResult.explanation || prevData.explanation || '',\n    impact: codeResult.impact || prevData.impact || '',\n    raw_response: response,\n    job_id: prevData.job_id,\n    chapter_id: prevData.chapter_id\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "caea5e44-6578-4c12-8282-54cbd042eb3e",
      "name": "ğŸ”— Parse Corrected Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3000,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "// Retry limit reached â€” store code with validated=false\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.code_snippets) staticData.code_snippets = [];\n\nconst data = $input.first().json;\n\nstaticData.code_snippets.push({\n  id: data.request_id,\n  description: data.description,\n  placeholder: data.placeholder,\n  code: data.code,\n  language: data.language,\n  explanation: data.explanation || '',\n  impact: data.impact || '',\n  validated: false,\n  retries: data.retry_count || 0,\n  errors: data.code_errors || []\n});\n\nreturn [{ json: { collected: true, request_id: data.request_id, validated: false } }];",
        "mode": "runOnceForAllItems"
      },
      "id": "35e8b717-79ab-4b7d-b578-0289630c83d2",
      "name": "ğŸ“¦ Accept As-Is",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2750,
        700
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build final structured output from all collected snippets\nconst staticData = $getWorkflowStaticData('global');\nconst codeSnippets = staticData.code_snippets || [];\nconst validated = $('âœ… Validate Input').first().json;\n\n// Clean up static data\ndelete staticData.code_snippets;\ndelete staticData.current_retry;\n\n// If no code requests were processed (skip flag)\nif (codeSnippets.length === 0) {\n  return [{\n    json: {\n      status: 'success',\n      code_snippets: [],\n      total_snippets: 0,\n      validated_count: 0,\n      job_id: validated.job_id,\n      chapter_id: validated.chapter_id\n    }\n  }];\n}\n\nconst validatedCount = codeSnippets.filter(s => s.validated).length;\n\nreturn [{\n  json: {\n    status: 'success',\n    code_snippets: codeSnippets,\n    total_snippets: codeSnippets.length,\n    validated_count: validatedCount,\n    all_validated: validatedCount === codeSnippets.length,\n    job_id: validated.job_id,\n    chapter_id: validated.chapter_id\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "be261ce8-2097-402a-a2c4-3b83686eae3b",
      "name": "ğŸ“Š Build Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        100
      ]
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "âœ… Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Validate Input": {
      "main": [
        [
          {
            "node": "ğŸ“ Prepare Code Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Prepare Code Items": {
      "main": [
        [
          {
            "node": "ğŸ” Code Request Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Code Request Loop": {
      "main": [
        [
          {
            "node": "ğŸ“Š Build Output",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“ Init Request Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Init Request Context": {
      "main": [
        [
          {
            "node": "ğŸ’» WPI Coder Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’» WPI Coder Agent": {
      "main": [
        [
          {
            "node": "ğŸ”— Parse Code Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”— Parse Code Response": {
      "main": [
        [
          {
            "node": "ğŸ”¬ MCP: Validate Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”¬ MCP: Validate Code": {
      "main": [
        [
          {
            "node": "ğŸ“Š Parse Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Parse Validation": {
      "main": [
        [
          {
            "node": "ğŸ”€ Code Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Code Valid?": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Collect Valid Result",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”€ Retry Limit?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Collect Valid Result": {
      "main": [
        [
          {
            "node": "ğŸ” Code Request Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Retry Limit?": {
      "main": [
        [
          {
            "node": "ğŸ”„ WPI Coder Self-Correct",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¦ Accept As-Is",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ WPI Coder Self-Correct": {
      "main": [
        [
          {
            "node": "ğŸ”— Parse Corrected Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”— Parse Corrected Code": {
      "main": [
        [
          {
            "node": "ğŸ”¬ MCP: Validate Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Accept As-Is": {
      "main": [
        [
          {
            "node": "ğŸ” Code Request Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  }
}