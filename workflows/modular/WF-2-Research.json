{
  "name": "WF-2 Research Workflow",
  "nodes": [
    {
      "parameters": {},
      "id": "db179d5f-59d8-4fff-8416-c5087d89e934",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Validate input from WF-0 Manager\nconst input = $input.first().json;\n\nconst required = ['job_id', 'chapter_id', 'domain_id'];\nconst missing = required.filter(f => !input[f]);\n\nif (missing.length > 0) {\n  throw new Error('WF-2 input validation failed. Missing: ' + missing.join(', '));\n}\n\nreturn [{\n  json: {\n    job_id: input.job_id,\n    chapter_id: input.chapter_id,\n    title: input.title || 'Untitled Chapter',\n    learning_objectives: input.learning_objectives || [],\n    domain_id: input.domain_id,\n    syllabus_id: input.syllabus_id || '',\n    target_audience: input.target_audience || 'Mid-Level Professionals',\n    global_history: input.global_history || '',\n    chapter_index: input.chapter_index || 0\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "bbe4ac0b-5a3a-48ee-b329-479be054453f",
      "name": "âœ… Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-standards:3002/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'get_syllabus_section',\n  arguments: {\n    domain_id: $json.domain_id,\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "cb0a588d-db07-497e-a9af-5fe00d232ada",
      "name": "ğŸ“š MCP: Get Syllabus Section",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        500,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-research:3003/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'hybrid_search',\n  arguments: {\n    query: $json.title + ' ' + ($json.learning_objectives || []).map(function(lo) { return lo.description || lo; }).join(' '),\n    filter_metadata: {\n      domain_id: $json.domain_id\n    },\n    limit: 5,\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "d7636a01-e7ec-4587-85b7-6f91eb4989a0",
      "name": "ğŸ” MCP: Chapter Research",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        500,
        400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "append",
        "numberInputs": 2
      },
      "id": "5dd8af17-5467-449a-8b3c-001240d529cf",
      "name": "ğŸ”€ Merge MCP Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        750,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse syllabus section + chapter research results\nconst validated = $('âœ… Validate Input').first().json;\n\n// Parse syllabus section\nlet syllabusSection = null;\nlet syllabusLOs = [];\ntry {\n  const resp = $('ğŸ“š MCP: Get Syllabus Section').first().json;\n  if (resp.body?.content?.[0]?.text) {\n    const parsed = JSON.parse(resp.body.content[0].text);\n    syllabusSection = parsed.section || parsed;\n    // Extract LOs from syllabus section\n    if (parsed.section?.topics) {\n      for (const topic of parsed.section.topics) {\n        if (topic.learning_objectives) {\n          syllabusLOs = syllabusLOs.concat(topic.learning_objectives);\n        }\n      }\n    }\n    if (parsed.learning_objectives) {\n      syllabusLOs = syllabusLOs.concat(parsed.learning_objectives);\n    }\n  }\n} catch (e) {\n  // Syllabus fetch failed, continuing without\n}\n\n// Parse chapter research\nlet chapterResearch = [];\ntry {\n  const resp = $('ğŸ” MCP: Chapter Research').first().json;\n  if (resp.body?.content?.[0]?.text) {\n    const parsed = JSON.parse(resp.body.content[0].text);\n    chapterResearch = parsed.results || [];\n  }\n} catch (e) {\n  // Research fetch failed, continuing without\n}\n\n// Prepare LOs for per-LO RAG lookup\nconst los = validated.learning_objectives || [];\n\nreturn [{\n  json: {\n    ...validated,\n    syllabus_section: syllabusSection,\n    syllabus_los: syllabusLOs,\n    chapter_research: chapterResearch,\n    lo_count: los.length,\n    lo_rag_results: {}\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "53830d8e-b791-4a01-9cad-39d51d03acc9",
      "name": "ğŸ“‹ Parse MCP Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Convert learning_objectives array into items for SplitInBatches\nconst data = $input.first().json;\nconst los = data.learning_objectives || [];\n\nif (los.length === 0) {\n  // No LOs â€” skip RAG and return accumulated data\n  return [{\n    json: {\n      ...data,\n      _skip_rag: true\n    }\n  }];\n}\n\nreturn los.map(lo => ({\n  json: {\n    lo_id: lo.id || 'unknown',\n    lo_description: lo.description || String(lo),\n    bloom_level: lo.bloom_level || 'K2',\n    domain_id: data.domain_id,\n    _parent_data: data\n  }\n}));",
        "mode": "runOnceForAllItems"
      },
      "id": "f16de7f2-8a15-46fb-a18f-062d31f6253f",
      "name": "ğŸ“ Prepare LO Items",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "590629a4-05d9-498d-b702-32447a99ee7c",
      "name": "ğŸ” LO RAG Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1500,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-research:3003/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'hybrid_search',\n  arguments: {\n    query: $json.lo_description,\n    filter_metadata: {\n      domain_id: $json.domain_id\n    },\n    limit: 3,\n    output_format: 'json'\n  }\n}) }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "a9174c93-b97e-403e-b25d-eb7a4df23255",
      "name": "ğŸ” RAG: Query Per LO",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1750,
        500
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Parse RAG result for this LO and store in static data\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.lo_rag_results) staticData.lo_rag_results = {};\n\nconst loData = $('ğŸ” LO RAG Loop').first().json;\nconst loId = loData.lo_id || 'unknown';\n\nlet ragChunks = [];\ntry {\n  const resp = $input.first().json;\n  if (resp.body?.content?.[0]?.text) {\n    const parsed = JSON.parse(resp.body.content[0].text);\n    ragChunks = (parsed.results || []).map(r => ({\n      text: r.text || r.content || '',\n      score: r.score || r.relevance || 0,\n      source: r.source || r.metadata?.source || ''\n    }));\n  }\n} catch (e) {\n  // RAG query failed for this LO\n}\n\nstaticData.lo_rag_results[loId] = {\n  rag_chunks: ragChunks,\n  description: loData.lo_description,\n  bloom_level: loData.bloom_level\n};\n\nreturn [{ json: { lo_id: loId, rag_count: ragChunks.length } }];",
        "mode": "runOnceForAllItems"
      },
      "id": "323249e2-0e9d-41fb-938a-b02d7ac22998",
      "name": "ğŸ“¦ Collect LO RAG Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build structured fact sheet from all research results\nconst staticData = $getWorkflowStaticData('global');\nconst loRagResults = staticData.lo_rag_results || {};\n\n// Get the parent data (from Parse MCP Results)\nconst parentData = $('ğŸ“‹ Parse MCP Results').first().json;\n\n// Build per-LO research map\nconst loResearch = {};\nfor (const [loId, data] of Object.entries(loRagResults)) {\n  loResearch[loId] = {\n    description: data.description,\n    bloom_level: data.bloom_level,\n    rag_chunks: data.rag_chunks || [],\n    kb_facts: []\n  };\n}\n\n// Add chapter-level KB facts to each LO\nconst chapterResearch = parentData.chapter_research || [];\nfor (const [loId, data] of Object.entries(loResearch)) {\n  // Match KB facts by relevance to LO description\n  data.kb_facts = chapterResearch.filter(r =>\n    (r.text || '').toLowerCase().includes(data.description.toLowerCase().split(' ')[0])\n  ).slice(0, 3);\n}\n\n// Collect all sources\nconst allSources = new Set();\nfor (const data of Object.values(loResearch)) {\n  for (const chunk of data.rag_chunks) {\n    if (chunk.source) allSources.add(chunk.source);\n  }\n}\nfor (const r of chapterResearch) {\n  if (r.source) allSources.add(r.source);\n}\n\n// Build chapter context summary\nconst chapterContext = [\n  'Chapter: ' + parentData.title,\n  'Domain: ' + parentData.domain_id,\n  'Target Audience: ' + parentData.target_audience,\n  'Learning Objectives: ' + (parentData.learning_objectives || []).length,\n  parentData.syllabus_section ? 'Syllabus data available' : 'No syllabus data'\n].join(' | ');\n\n// Clean up static data\ndelete staticData.lo_rag_results;\n\nreturn [{\n  json: {\n    status: 'success',\n    fact_sheet: {\n      chapter_context: chapterContext,\n      syllabus_section: parentData.syllabus_section,\n      syllabus_los: parentData.syllabus_los || [],\n      chapter_research: chapterResearch,\n      lo_research: loResearch,\n      sources: Array.from(allSources)\n    },\n    // Pass through chapter data for downstream workflows\n    job_id: parentData.job_id,\n    chapter_id: parentData.chapter_id,\n    title: parentData.title,\n    learning_objectives: parentData.learning_objectives,\n    domain_id: parentData.domain_id,\n    target_audience: parentData.target_audience,\n    global_history: parentData.global_history\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "8a564cd6-e596-4a59-b966-0c9cdda4f594",
      "name": "ğŸ“Š Build Fact Sheet",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1750,
        100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-research:3003/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  name: 'store_document',\n  arguments: {\n    content: 'Research fact sheet for chapter: ' + $json.title + '. LOs researched: ' + Object.keys($json.fact_sheet.lo_research || {}).length + '. Sources: ' + ($json.fact_sheet.sources || []).length,\n    metadata: {\n      type: 'research_fact_sheet',\n      chapter_id: $json.chapter_id,\n      job_id: $json.job_id,\n      domain_id: $json.domain_id\n    }\n  }\n}) }}",
        "options": {}
      },
      "id": "d13149db-256c-42f0-b6bc-10f0583c495f",
      "name": "ğŸ’¾ MCP: Store Research",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        100
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "âœ… Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Validate Input": {
      "main": [
        [
          {
            "node": "ğŸ“š MCP: Get Syllabus Section",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ” MCP: Chapter Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“š MCP: Get Syllabus Section": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge MCP Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” MCP: Chapter Research": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge MCP Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ”€ Merge MCP Results": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Parse MCP Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Parse MCP Results": {
      "main": [
        [
          {
            "node": "ğŸ“ Prepare LO Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Prepare LO Items": {
      "main": [
        [
          {
            "node": "ğŸ” LO RAG Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” LO RAG Loop": {
      "main": [
        [
          {
            "node": "ğŸ“Š Build Fact Sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” RAG: Query Per LO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” RAG: Query Per LO": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Collect LO RAG Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Collect LO RAG Result": {
      "main": [
        [
          {
            "node": "ğŸ” LO RAG Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Build Fact Sheet": {
      "main": [
        [
          {
            "node": "ğŸ’¾ MCP: Store Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  }
}