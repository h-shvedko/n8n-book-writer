{
  "name": "WF-5 Editor / QA",
  "nodes": [
    {
      "parameters": {
        "mode": "anyInput"
      },
      "id": "a5094cf5-b2d0-466f-9846-07df729746d2",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Validate input from WF-0 Manager\nconst input = $input.first().json;\n\nconst required = ['job_id', 'chapter_id', 'json_content', 'learning_objectives'];\nconst missing = required.filter(f => !input[f]);\n\nif (missing.length > 0) {\n  throw new Error('WF-5 input validation failed. Missing: ' + missing.join(', '));\n}\n\n// Ensure learning_objectives is an array\nconst los = Array.isArray(input.learning_objectives)\n  ? input.learning_objectives\n  : [input.learning_objectives];\n\nreturn [{\n  json: {\n    job_id: input.job_id,\n    chapter_id: input.chapter_id,\n    chapter_title: input.chapter_title || input.title || 'Untitled',\n    chapter_number: input.chapter_number || '?',\n    domain_id: input.domain_id || '',\n    json_content: input.json_content,\n    code_snippets: input.code_snippets || [],\n    learning_objectives: los,\n    target_audience: input.target_audience || 'Mid-Level Professionals'\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "85c591ce-fe62-4a87-a15c-0a9c5b3018c1",
      "name": "âœ… Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// R2.2.4: Structural pre-check â€” validate chapter JSON schema before quality scoring\nconst input = $input.first().json;\nlet chapter;\ntry {\n  chapter = typeof input.json_content === 'string'\n    ? JSON.parse(input.json_content)\n    : input.json_content;\n} catch (e) {\n  return [{ json: { ...input, schema_valid: false, schema_errors: ['json_content is not valid JSON: ' + e.message] } }];\n}\n\nfunction validateChapterSchema(ch) {\n  const errors = [];\n  const required = ['chapter_id', 'title', 'metadata', 'sections', 'summary', 'assessment'];\n  for (const key of required) {\n    if (ch[key] === undefined || ch[key] === null) {\n      errors.push('Missing required key: ' + key);\n    }\n  }\n  if (typeof ch.chapter_id !== 'string') errors.push('chapter_id must be a string');\n  if (typeof ch.title !== 'string' || !ch.title) errors.push('title must be a non-empty string');\n  if (typeof ch.summary !== 'string' || !ch.summary) errors.push('summary must be a non-empty string');\n  // metadata\n  if (ch.metadata && typeof ch.metadata === 'object') {\n    if (!ch.metadata.header) errors.push('Missing metadata.header');\n    if (!ch.metadata.learning_objectives) errors.push('Missing metadata.learning_objectives');\n    else if (!Array.isArray(ch.metadata.learning_objectives)) errors.push('metadata.learning_objectives must be an array');\n    if (!ch.metadata.professional_context) errors.push('Missing metadata.professional_context');\n  }\n  // sections\n  if (Array.isArray(ch.sections)) {\n    if (ch.sections.length === 0) errors.push('sections must be a non-empty array');\n    ch.sections.forEach(function(s, i) {\n      if (!s.lo_id) errors.push('sections[' + i + '] missing lo_id');\n      if (!s.theory_content) errors.push('sections[' + i + '] missing theory_content');\n      else if (!Array.isArray(s.theory_content)) errors.push('sections[' + i + '].theory_content must be an array');\n      if (!s.key_takeaway) errors.push('sections[' + i + '] missing key_takeaway');\n    });\n  } else if (ch.sections !== undefined) {\n    errors.push('sections must be an array');\n  }\n  // assessment\n  if (ch.assessment && typeof ch.assessment === 'object') {\n    if (!Array.isArray(ch.assessment.mcqs)) errors.push('assessment.mcqs must be an array');\n    else if (ch.assessment.mcqs.length === 0) errors.push('assessment.mcqs must not be empty');\n    if (!ch.assessment.drill || typeof ch.assessment.drill !== 'object') errors.push('assessment.drill must be an object');\n  }\n  return { valid: errors.length === 0, errors: errors };\n}\n\nconst result = validateChapterSchema(chapter);\n\nreturn [{ json: {\n  ...input,\n  schema_valid: result.valid,\n  schema_errors: result.errors\n}}];",
        "mode": "runOnceForAllItems"
      },
      "id": "c1d2e3f4-a5b6-4c89-9123-456789abcdef",
      "name": "ğŸ”’ Schema Pre-Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://mcp-standards:3002/call",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ (function() {\n  const content = typeof $json.json_content === 'string'\n    ? $json.json_content\n    : JSON.stringify($json.json_content);\n  return JSON.stringify({\n    name: 'validate_iso_compliance',\n    arguments: {\n      content: content.substring(0, 10000),\n      output_format: 'json'\n    }\n  });\n})() }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "3fa10885-220d-4d78-9f2b-cee0468fd239",
      "name": "ğŸ“‹ MCP: ISO Compliance Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        750,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "xOk2J7CAxWG1jwph",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Parse MCP ISO Compliance response\nconst validated = $('âœ… Validate Input').first().json;\n\nlet isoResult = { compliant: false, details: 'ISO check unavailable' };\ntry {\n  const resp = $input.first().json;\n  if (resp.body?.content?.[0]?.text) {\n    isoResult = JSON.parse(resp.body.content[0].text);\n  }\n} catch (e) {\n  isoResult = { compliant: false, details: 'Failed to parse ISO result: ' + e.message };\n}\n\nreturn [{\n  json: {\n    ...validated,\n    iso_compliance: isoResult\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "98a4fdbe-f5dc-4fc6-b92d-7971058eadac",
      "name": "ğŸ“Š Parse ISO Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Check that every LO from the chapter blueprint has corresponding content\nconst data = $input.first().json;\nconst los = data.learning_objectives || [];\n\n// Flatten json_content to searchable text\nconst contentStr = typeof data.json_content === 'string'\n  ? data.json_content.toLowerCase()\n  : JSON.stringify(data.json_content).toLowerCase();\n\nconst loCoverage = {};\nlet coveredCount = 0;\n\nfor (const lo of los) {\n  // Extract meaningful text from the LO\n  const loText = typeof lo === 'string' ? lo : (lo.title || lo.description || lo.id || String(lo));\n  const loId = typeof lo === 'object' ? (lo.id || lo.lo_id || loText) : loText;\n\n  // Check if LO keywords appear in content\n  // Split LO into keywords (at least 3 chars), ignore common stop words\n  const stopWords = ['und', 'die', 'der', 'das', 'fÃ¼r', 'von', 'mit', 'den', 'des', 'ein', 'eine', 'ist', 'are', 'the', 'and', 'for', 'can', 'will', 'how', 'was', 'bei'];\n  const keywords = loText.toLowerCase()\n    .replace(/[^a-zÃ¤Ã¶Ã¼ÃŸ\\s]/gi, ' ')\n    .split(/\\s+/)\n    .filter(w => w.length >= 3 && !stopWords.includes(w));\n\n  // LO is considered covered if >= 50% of its keywords appear in content\n  const found = keywords.filter(kw => contentStr.includes(kw));\n  const coverage = keywords.length > 0 ? found.length / keywords.length : 0;\n  const isCovered = coverage >= 0.5;\n\n  loCoverage[loId] = isCovered;\n  if (isCovered) coveredCount++;\n}\n\nconst allCovered = coveredCount === los.length;\nconst coveragePercent = los.length > 0 ? Math.round((coveredCount / los.length) * 100) : 100;\n\nreturn [{\n  json: {\n    ...data,\n    lo_coverage: loCoverage,\n    lo_coverage_summary: {\n      total: los.length,\n      covered: coveredCount,\n      missing: los.length - coveredCount,\n      percent: coveragePercent,\n      all_covered: allCovered\n    }\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "3c53112c-4449-416a-8a5f-78fabae94b22",
      "name": "ğŸ” LO Coverage Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ (function() {\n  const data = $json;\n  const content = typeof data.json_content === 'string'\n    ? data.json_content\n    : JSON.stringify(data.json_content, null, 2);\n\n  const isoCompliance = data.iso_compliance || {};\n  const loCoverageSummary = data.lo_coverage_summary || {};\n  const codeSnippets = data.code_snippets || [];\n\n  const losText = (data.learning_objectives || []).map(function(lo, i) {\n    var text = typeof lo === 'string' ? lo : (lo.title || lo.description || lo.id || String(lo));\n    return (i + 1) + '. ' + text;\n  }).join('\\n');\n\n  const codeInfo = codeSnippets.length > 0\n    ? 'Code Snippets included: ' + codeSnippets.length + ' (validated: ' + codeSnippets.filter(function(s) { return s.validated; }).length + ')'\n    : 'No code snippets for this chapter';\n\n  return JSON.stringify({\n    model: 'gpt-4o',\n    temperature: 0.2,\n    max_tokens: 4000,\n    messages: [\n      {\n        role: 'system',\n        content: '## Your Identity\\nYou are the \"WPI ISO Editor,\" a meticulous quality assurance expert specialized in the ISO 17024 standard and technical didactics. Your role is to audit content generated by the Writer and Coder agents to ensure it is \"Exam-Ready\" and free of \"Fluff.\"\\n\\n## Core Audit Criteria\\n\\n### 1. Syllabus & Bloom Compliance\\n- **Coverage:** Verify that every Learning Objective (LO) from the provided list is addressed\\n- **Bloom Level:** Ensure depth matches target taxonomy (K4 must describe diagnostic paths, not just definitions)\\n- **Fact Check:** Cross-reference technical claims against ISO 17024 standards\\n\\n### 2. WPI Tone & Quality Standard\\n- **Neutrality:** Confirm neutral, factual tone\\n- **Address (CRITICAL):** STRICTLY ENFORCE removal of \"Du\" or \"Sie\" in technical instructions. Use passive voice or direct imperatives only.\\n  - DEDUCT -5 pts per Du/Sie violation\\n- **Structure:** Max 5-6 line paragraphs, bold key terms, zero filler words\\n- **Acronyms:** First-Mention Rule - all acronyms must be defined on first use (-2 pts per violation)\\n\\n### 3. Tangibility Mandate\\n- **Code-First:** Every technical topic MUST have syntactically correct code block\\n- **No Placeholders:** No \"// TODO\" or incomplete code\\n- **Calculations:** Show complete calculation paths for metrics\\n\\n### 4. Hallucination Check (CRITICAL)\\n- **ONLY the listed Learning Objectives should be covered**\\n- If content covers topics NOT in the provided LO list, flag as \"hallucinated_topics\"\\n- Content should stay strictly within the scope of this chapter\\'s LOs\\n- Do NOT penalize tangential explanations that SUPPORT the listed LOs\\n\\n## Scoring System (0-100)\\n- LO Completeness: 30 pts (All learning goals covered with Bloom-level depth?)\\n- Clarity & Tone: 25 pts (Zero fluff, correct voice? -5 per Du/Sie, -2 per undefined acronym)\\n- Code Quality: 20 pts (Tangible, commented examples? No placeholders?)\\n- Didactic Structure: 15 pts (Scenario -> Logic -> Takeaways included?)\\n- Exercises: 10 pts (Meaningful Check Your Knowledge + Scenario Drills?)\\n\\n## APPROVAL THRESHOLD\\n- **Score >= 90** \\u2192 approved\\n- **Score < 90** \\u2192 needs_revision (provide specific required_changes)\\n\\n## Output Format (JSON ONLY - no markdown)\\n{\\n  \"score\": number,\\n  \"approved\": boolean,\\n  \"iso_compliant\": boolean,\\n  \"hallucinated_topics\": [],\\n  \"audit_log\": {\\n    \"satisfied_LOs\": [\"LO-1.1.1\"],\\n    \"missing_LOs\": [],\\n    \"tone_violations\": [],\\n    \"undefined_acronyms\": [],\\n    \"code_blocks_count\": number,\\n    \"code_validation_passed\": boolean\\n  },\\n  \"scoring_breakdown\": {\\n    \"lo_completeness\": number,\\n    \"clarity_and_tone\": number,\\n    \"code_quality\": number,\\n    \"didactic_structure\": number,\\n    \"exercises\": number\\n  },\\n  \"feedback\": {\\n    \"strengths\": [],\\n    \"required_changes\": []\\n  },\\n  \"exam_questions\": [{\\n    \"question\": \"string\",\\n    \"options\": [\"A)\", \"B)\", \"C)\", \"D)\"],\\n    \"correct\": \"char\",\\n    \"bloom_level\": \"string\",\\n    \"learning_objective\": \"string\",\\n    \"explanation\": \"string\"\\n  }]\\n}'\n      },\n      {\n        role: 'user',\n        content: '## AUDIT REQUEST\\n\\n**Chapter ' + (data.chapter_number || '?') + ':** ' + (data.chapter_title || 'Unknown') + '\\n\\n### Target Learning Objectives (ONLY these should be covered):\\n' + losText + '\\n\\n### ISO 17024 Compliance Tool Result:\\n' + JSON.stringify(isoCompliance, null, 2) + '\\n\\n### LO Coverage Pre-Check:\\n' + JSON.stringify(loCoverageSummary, null, 2) + '\\n\\n### ' + codeInfo + '\\n\\n### Chapter Content to Audit (JSON FORMAT):\\n\\n' + content.substring(0, 12000) + '\\n\\n---\\n**AUDIT INSTRUCTIONS:**\\n1. Check each LO for coverage and Bloom-level depth\\n2. Scan for Du/Sie violations (CRITICAL: -5 pts each)\\n3. Count code blocks, verify no placeholders\\n4. Check structure (intro -> concepts -> practice -> summary)\\n5. Check for HALLUCINATED TOPICS not in the LO list above\\n6. Verify exercises are meaningful\\n7. Calculate score using 5 criteria (max 100)\\n8. Generate 5-8 exam questions covering different LOs\\n9. Return ONLY valid JSON (no markdown code blocks)'\n      }\n    ]\n  });\n})() }}",
        "options": {}
      },
      "id": "40b8df4b-8164-47fa-86e0-9efe81eb4142",
      "name": "ğŸ” WPI ISO Editor",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1500,
        300
      ],
      "credentials": {
        "openAiApi": {
          "id": "5KnJ49CiBjEEjtWM",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse WPI ISO Editor AI response\nconst prevData = $('ğŸ” LO Coverage Check').first().json;\nconst response = $input.first().json.choices[0].message?.content || '';\n\nlet editorResult;\ntry {\n  let jsonStr = response;\n  if (response.includes('```json')) {\n    jsonStr = response.split('```json')[1].split('```')[0];\n  } else if (response.includes('```')) {\n    jsonStr = response.split('```')[1].split('```')[0];\n  }\n  editorResult = JSON.parse(jsonStr.trim());\n} catch (e) {\n  editorResult = {\n    score: 0,\n    approved: false,\n    iso_compliant: false,\n    hallucinated_topics: [],\n    audit_log: {\n      satisfied_LOs: [], missing_LOs: [], tone_violations: [],\n      undefined_acronyms: [], code_blocks_count: 0, code_validation_passed: false\n    },\n    scoring_breakdown: {\n      lo_completeness: 0, clarity_and_tone: 0, code_quality: 0,\n      didactic_structure: 0, exercises: 0\n    },\n    feedback: {\n      strengths: [],\n      required_changes: ['Failed to parse ISO Editor response: ' + e.message]\n    },\n    exam_questions: []\n  };\n}\n\nreturn [{\n  json: {\n    ...prevData,\n    editor_result: editorResult\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "288e7b7b-da04-4261-b23e-f5abf009dae0",
      "name": "ğŸ“Š Parse Editor Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1750,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build structured output with verdict â€” no revision loop (6.8: Manager decides)\nconst data = $input.first().json;\nconst editor = data.editor_result || {};\nconst loCoverage = data.lo_coverage || {};\nconst loCoverageSummary = data.lo_coverage_summary || {};\n\n// Score threshold (6.6)\nconst APPROVAL_THRESHOLD = 90;\nconst score = editor.score || 0;\nconst schemaValid = data.schema_valid !== false;\nconst verdict = (score >= APPROVAL_THRESHOLD && schemaValid) ? 'approved' : 'needs_revision';\n\n// Build feedback combining all checks\nconst feedback = [];\n\n// Schema validation errors (R2.2.4)\nif (!schemaValid && data.schema_errors && data.schema_errors.length > 0) {\n  feedback.push('JSON Schema validation failed: ' + data.schema_errors.join('; '));\n}\n\n// Editor feedback\nif (editor.feedback?.required_changes) {\n  feedback.push(...editor.feedback.required_changes);\n}\n\n// LO coverage gaps\nif (!loCoverageSummary.all_covered) {\n  const missingLOs = Object.entries(loCoverage)\n    .filter(([_, covered]) => !covered)\n    .map(([loId]) => loId);\n  if (missingLOs.length > 0) {\n    feedback.push('Missing LO coverage: ' + missingLOs.join(', '));\n  }\n}\n\n// Hallucinated topics (6.5)\nif (editor.hallucinated_topics && editor.hallucinated_topics.length > 0) {\n  feedback.push('Hallucinated topics detected (content leak from other chapters): ' + editor.hallucinated_topics.join(', '));\n}\n\n// ISO compliance issues\nif (!editor.iso_compliant && data.iso_compliance) {\n  feedback.push('ISO 17024 compliance issues detected');\n}\n\nreturn [{\n  json: {\n    status: 'success',\n    verdict: verdict,\n    score: score,\n    approval_threshold: APPROVAL_THRESHOLD,\n    schema_valid: schemaValid,\n    schema_errors: data.schema_errors || [],\n    iso_compliant: !!editor.iso_compliant,\n    lo_coverage: loCoverage,\n    lo_coverage_summary: loCoverageSummary,\n    hallucinated_topics: editor.hallucinated_topics || [],\n    scoring_breakdown: editor.scoring_breakdown || {},\n    audit_log: editor.audit_log || {},\n    feedback: feedback,\n    strengths: editor.feedback?.strengths || [],\n    exam_questions: editor.exam_questions || [],\n    job_id: data.job_id,\n    chapter_id: data.chapter_id\n  }\n}];",
        "mode": "runOnceForAllItems"
      },
      "id": "b99ccdcc-809a-45b5-a011-b0d4556b162b",
      "name": "ğŸ“Š Build Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        300
      ]
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "âœ… Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Validate Input": {
      "main": [
        [
          {
            "node": "ğŸ”’ Schema Pre-Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ MCP: ISO Compliance Check": {
      "main": [
        [
          {
            "node": "ğŸ“Š Parse ISO Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Parse ISO Result": {
      "main": [
        [
          {
            "node": "ğŸ” LO Coverage Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” LO Coverage Check": {
      "main": [
        [
          {
            "node": "ğŸ” WPI ISO Editor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” WPI ISO Editor": {
      "main": [
        [
          {
            "node": "ğŸ“Š Parse Editor Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Parse Editor Response": {
      "main": [
        [
          {
            "node": "ğŸ“Š Build Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”’ Schema Pre-Check": {
      "main": [
        [
          {
            "node": "ğŸ“‹ MCP: ISO Compliance Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  }
}