services:
  # ============================================
  # n8n - Workflow Orchestration
  # ============================================
  n8n:
    image: n8nio/n8n:latest
    container_name: wpi-n8n
    restart: unless-stopped
    environment:
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - NODE_ENV=production
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      - GENERIC_TIMEZONE=${TIMEZONE:-Europe/Berlin}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-false}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-}
      # Enable AI features
      - N8N_AI_ENABLED=true
      # External hooks for MCP servers
      - N8N_EXTERNAL_HOOKS=true
    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/home/node/workflows:ro
    networks:
      - wpi-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ============================================
  # Qdrant - Vector Database
  # ============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: wpi-qdrant
    restart: unless-stopped
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - wpi-network
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/localhost/6333 && echo -e \"GET / HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n\" >&3 && cat <&3 | head -1 | grep -q 200'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ============================================
  # MCP Standards Server
  # ============================================
  mcp-standards:
    build:
      context: ./mcp-standards
      dockerfile: Dockerfile
    container_name: wpi-mcp-standards
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - MCP_MODE=http
      - PORT=3002
      - AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
      - DEFAULT_SYLLABUS_PATH=/app/data/default-syllabus.json
    ports:
      - "${MCP_STANDARDS_PORT:-3002}:3002"
    volumes:
      - ./mcp-standards/data:/app/data:ro
    networks:
      - wpi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ============================================
  # MCP Research Server (Vector DB Integration)
  # ============================================
  mcp-research:
    build:
      context: ./mcp-research
      dockerfile: Dockerfile
    container_name: wpi-mcp-research
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - MCP_MODE=http
      - PORT=3003
      - AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-wpi_content}
      - OPENAI_API_KEY=${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-1536}
      - INGESTION_DB_PATH=/app/data/ingestion.db
    ports:
      - "${MCP_RESEARCH_PORT:-3003}:3003"
    volumes:
      - mcp_research_data:/app/data
    depends_on:
      qdrant:
        condition: service_healthy
    networks:
      - wpi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ============================================
  # MCP Coder Server (Code Validation & Examples)
  # ============================================
  mcp-coder:
    build:
      context: ./mcp-coder
      dockerfile: Dockerfile
    container_name: wpi-mcp-coder
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - MCP_MODE=http
      - PORT=3004
      - AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
    ports:
      - "${MCP_CODER_PORT:-3004}:3004"
    networks:
      - wpi-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ============================================
  # n8n-MCP Server (Node Discovery & Validation)
  # ============================================
  n8n-mcp:
    image: ghcr.io/czlonkowski/n8n-mcp:latest
    container_name: wpi-n8n-mcp
    restart: unless-stopped
    environment:
      - MCP_MODE=http
      - AUTH_TOKEN=${MCP_AUTH_TOKEN:?AUTH_TOKEN is required for HTTP mode}
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=3000
      - NODE_DB_PATH=/app/data/nodes.db
      - REBUILD_ON_START=false
      # Optional: n8n API for workflow management
      - N8N_API_URL=http://n8n:5678/api/v1
      - N8N_API_KEY=${N8N_API_KEY:-}
    ports:
      - "${N8N_MCP_PORT:-3000}:3000"
    volumes:
      - n8n_mcp_data:/app/data
    networks:
      - wpi-network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ============================================
  # Admin Dashboard (React Frontend)
  # ============================================
  admin-fe:
    build:
      context: ./admin-fe
      dockerfile: Dockerfile
      args:
        - VITE_MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
    container_name: wpi-admin-fe
    restart: unless-stopped
    environment:
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
      - VITE_MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
      - N8N_API_KEY=${N8N_API_KEY:-}
    ports:
      - "${ADMIN_FE_PORT:-3001}:3001"
    depends_on:
      - mcp-standards
      - mcp-research
      - n8n
    networks:
      - wpi-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

# ============================================
# Networks
# ============================================
networks:
  wpi-network:
    driver: bridge
    name: wpi-content-factory

# ============================================
# Volumes
# ============================================
volumes:
  n8n_data:
    driver: local
    name: wpi-n8n-data
  qdrant_data:
    driver: local
    name: wpi-qdrant-data
  n8n_mcp_data:
    driver: local
    name: wpi-n8n-mcp-data
  mcp_research_data:
    driver: local
    name: wpi-mcp-research-data
